<script>

  var control_type = [[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]];
  var control_number = [[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]];
  var control_channel = [[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]];
  var snap = [[1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1]];
  var options = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
  //====================== MIDI ==========================

  var midi = null;
  var open_control_input_id = null
  var open_control_output_id = null
  var selected_layout = 0
  var open_control_detected = false
  navigator.requestMIDIAccess({ sysex: true }).then(onMIDISuccess, onMIDIFailure);

  function onMIDIFailure(msg) {
    console.log("Failed to get MIDI access - " + msg);
  }

  function onMIDISuccess(midiAccess) {
    midi = midiAccess;
    console.log("MIDI ready!");
    connect_label();
    midi.onstatechange = function (e) { ConnectEventHandler(e); };

    var inputs = midiAccess.inputs.values();
    for (var input = inputs.next(); input && !input.done; input = inputs.next()) {
      input.value.onmidimessage = MIDIMessageEventHandler;
      haveAtLeastOneDevice = true;
    }
  }

  function ConnectEventHandler(event) {
    console.log("ConnectEventHandler");
    // Print information about the (dis)connected MIDI controller
    // console.log("Ports", event.port.name, event.port.manufacturer, event.port.state, event.port.type);
    statusLabel = document.getElementById("Status Label");
    statusLabel.style.color = "red";
    statusLabel.innerHTML = "<b> Please connect open· control </b>";
    midi.outputs.forEach(output => {
      console.log(output.name);
      sendSysexHandshakeRequest(midi.outputs.get(output.id));
    });
  }

  function sendSysexHandshakeRequest(output) {
    var requestMessage = [240, 122, 29, 1, 19, 1, 247];
    output.send(requestMessage);
  }

  function onOpenControlDetected(maj_ver, min_ver) {

    midi.outputs.forEach(output => {
      if (output.name == "open.control" && output.id) {
        open_control_output_id = output.id;
        open_control_output = midi.outputs.get(open_control_output_id);
      }
    });

    if (!open_control_detected) {
      statusLabel.style.color = "#00FF55";
      statusLabel.innerHTML = "<b> open·control detected</b> <br> firmware version: " + maj_ver + "." + min_ver;
      var requestMessage = [240, 122, 29, 1, 19, 4, 247];
      open_control_detected = true;
      console.log("requestMessage");
      open_control_output.send(requestMessage);
    }
  }

  function MIDIMessageEventHandler(event) {
    if (event.data[1] == 122 && event.data[2] == 29 && event.data[3] == 1 && event.data[4] == 19) {
      if (event.data[5] == 68) {
        console.log("open control detected");
        console.log(event.data);
        onOpenControlDetected(event.data[6], event.data[7]);
      }
      if (event.data[5] == 4) {
        var rcvd_layout = event.data[6];
        var num = event.data[7];
        var btn_num = event.data[8];
        var btn_chnl = event.data[9];
        var btn_type = event.data[10];
        if (num < 22) {
          control_number[rcvd_layout][num] = btn_num;
          control_channel[rcvd_layout][num] = btn_chnl;
          control_type[rcvd_layout][num] = btn_type;
        }
        else {
          set_External_MIDI(num - 22, btn_num, btn_chnl, btn_type + 1);
        }
      }
      if (event.data[5] == 16) {
        var rcvd_layout = event.data[6];
        var num = event.data[7];
        var btn_snap = event.data[8];
        snap[rcvd_layout][num] = btn_snap;
      }
      if (event.data[5] == 17) {
        var rcvd_opt = event.data[7];
        var num = event.data[6];
        options[num] = rcvd_opt;
    console.log("options", num, rcvd_opt);
      }
      if (event.data[5] == 79) {

      var s = document.getElementById("metro");
      s.checked = options[0];
      s = document.getElementById("session_box");
      s.checked = !options[1];
        change_layout(0);
      }
    }
  }

  function sendSysex(sysex_id, layout, id, value, type, channel) {
    // Sending {240, 122, 29, 1, 19, 10, Layout Number, Button number, Note/CC Number, Type, Channel, 247} changes the corresponding button
    var sysexMessage = [240, 122, 29, 1, 19, sysex_id, layout, id, value, type, channel, 247];
    if (open_control_output_id != null) open_control_output.send(sysexMessage);
  }

  function sendRawSysex(sysex_message) {
    // Sending {{240, 122, 29, 1, 19, 10, Layout Number, Button number, Note/CC Number, Type, Channel, 247} changes the corresponding button
    //var sysexMessage = [240, 122, 29, 1, 19, 10, layout, id, value, 1, 16, 247];
    //var output = midi.outputs.get(open_control_output_id);
    if (open_control_output_id != null) open_control_output.send(sysex_message);
  }

  function uploadPreset() {
    console.log("control_number2", control_number);
    for (layout = 0; layout < 3; layout++) {
      for (control = 0; control < NUM_CONTROLS - 3; control++) {
        sendSysex(layout, control, control_number[layout][control], 1, 16);
        // sel = document.getElementById("sel" + control);
        console.log(layout, control_number[layout][control]);
        // sel.value = Object.values(button_actions).indexOf([control_number[layout][control]]);
      }
      //sendSysexHandshakeRequest();
    }

    // change_layout(0);
  }


  //====================== JAVASCRIPT ==========================

  var current_layout = 0;
  var NUM_CONTROLS = 25;
  var layout_actions = {
    "Page 1": 0,
    "Page 2": 1,
    "Page 3": 2
  };
  var display_actions = {
    "Scene Name": 0,
    "Track Name": 1,
    "Looper number": 2,
    "Variation number / Rack Name": 3,
    "Left Marker Name": 4
  };
  var button_actions = {
    "Off": 0,
    "--- Global ---": 0,
    "■/▶ Start/Stop": 1,
    "●○ Metronome": 2,
    "⤶ Undo": 4,
    "▢ Capture": 5,
    "⊕ BPM +1": 28,
    "⊖ BPM -1": 29,
    "⮂ Arr./Session Toggle": 75,
    "Clip/Device Toggle": 76,
    "--- Arrangement ---": 0,
    "↞ Jump to 1.1.1": 74,
    "⇉ Restart From Last Pos.": 103,
    "● Arrangement Rec": 6,
    "⥁ Arrangement Loop": 7,
    "⇤ Go to Prev Marker": 9,
    "⇥ Go to Next Marker": 8,
    "⤓ Add/Delete Marker": 10,
    "⥀ Loop to Next Marker": 102,
    "Punch In": 0,
    "Punch Out": 0,
    "--- Session ---": 0,
    "○ Session Rec": 11,
    "▶ Launch Scene": 13,
    "⬆ Sel Prev Scene": 14,
    "⬇ Sel Next Scene": 15,
    "⥴ Jump to Playing Scene": 16,
    "⥅ Insert Scene": 17,
    "⧈ Stop All Clips": 3,
    "➟ Disable Follow Actions": 12,
    "--- Tracks ---": 0,
    "← Sel Prev Track": 18,
    "→ Sel Next Track": 19,
    "▷ Launch Clip": 22,
    "↳ Find Empty Slot": 23,
    "⌧ Mute": 24,
    "S Solo": 25,
    "⌻ Arm": 26,
    "■ Stop": 27,
    "U Fold/Unfold Track": 55,
    "☆ Add Audio Track": 20,
    "✬ Add MIDI Track": 21,
    "--- Looper ---": 0,
    "⧀ Prev Looper": 48,
    "⧁ Next Looper": 49,
    "① MIDI Map 1 (Big Button)": 0,
    "② MIDI Map 2 (Clear)": 0,
    "③ MIDI Map 3 (Free)": 0,
    "④ MIDI Map 4 (Free)": 0,
    "⑤ MIDI Map 5 (Free)": 0,
    "⑥ MIDI Map 6 (Free)": 0,
    "▣ Stop Looper": 35,
    "⌻ Arm Looper Track": 30,
    "⌧ Mute Looper Track": 31,
    "⌸ Show Looper": 32,
    "+ Add Looper": 47,
    "∅ Clear All": 36,
    "--- Variations ---": 0,
    "⍇ Prev Device": 65,
    "⍈ Next Device": 66,
    "⌃ Prev Variation": 67,
    "⌵ Next Variation": 68,
    "▹ Launch Variation": 69,
    "◦ Store Variation": 70,
    "↩︎ Recall Last Used": 72,
    "⌁ Randomize Macros": 71,
    "--- Pages ---": 0,
    "⇆ Page 2": 50,
    "⇆ Page 3": 51,
    "↩ Prev Page": 56,
    "↪ Next Page": 57
  };
  var led_actions = {
    "Custom Color": 0,
    "--- Global ---": 0,
    "■/▶ Start/Stop": 1,
    "●○ Metronome": 2,
    "● Arrangement Rec": 6,
    "⥁ Arrangement Loop": 7,
    // "⇥ Go to Next Marker": 8,
    // "⇤ Go to Prev Marker": 9,
    // "⤓ Add/Delete Marker": 10,
    "○ Session Rec": 11,
    "--- Scenes ---": 0,
    "▶ Selected Scene Color": 13,
    "⬆ Prev Scene Color": 14,
    "⬇ Next Scene Color": 15,
    "➟ Disable Follow Actions": 12,
    "--- Tracks ---": 0,
    "✽ Selected Track Color": 54,
    "← Prev Track Color": 18,
    "→ Next Track Color": 19,
    "▷ Clip Color": 22,
    "⌧ Mute": 24,
    "S Solo": 25,
    "⌻ Arm": 26,
    "■ Stop": 27,
    "--- Looper ---": 0,
    "⧀ Prev Looper Track Color": 48,
    "⧁ Next Looper Track Color": 49,
    "◈ Looper State": 53,
    "⌻ Looper Track Arm": 30,
    "⌧ Looper Track Mute": 31,
    "--- Pages ---": 0,
    "⇆ Page Color": 58,
  };
  var slider_actions = {
    "--- Global ---": 0,
    "Last Selected Parameter": 73,
    "Global Groove Amount": 0,
    "Arrangement Loop Start": 0,
    "Arrangement Loop Length": 0,
    "Scroll Scenes": 0,
    "--- Selected Track ---": 0,
    "Send A": 59,
    "Send B": 60,
    "Selected Device Param 1": 61,
    "Selected Device Param 2": 62,
    "Device 1 Param 1": 63,
    "Device 1 Param 2": 64,
    "--- Looper Track ---": 0,
    "Looper Device 1 Param 1": 33,
    "Looper Device 1 Param 2": 34,
  };
  var led_translator = {
    "Off": "Off",
    "▶ Launch Scene": "▶ Selected Scene Color",
    "⬆ Sel Prev Scene": "⬆ Prev Scene Color",
    "⬇ Sel Next Scene": "⬇ Next Scene Color",
    "■/▶ Start/Stop": "■/▶ Start/Stop",
    "●○ Metronome": "●○ Metronome",
    "■ Stop All Clips": 0,
    "● Arrangement Rec": "● Arrangement Rec",
    "⥁ Arrangement Loop": "⥁ Arrangement Loop",
    "⇥ Go to Next Marker": 0,
    "⇤ Go to Prev Marker": 0,
    "⤓ Add/Delete Marker": 0,
    "○ Session Rec": "○ Session Rec",
    "➟ Disable Follow Actions": 0,
    "▷ Launch Clip": "▷ Clip Color",
    "↳ Find Empty Slot": 0,
    "⌧ Mute": "⌧ Mute",
    "S Solo": "S Solo",
    "⌻ Arm": "⌻ Arm",
    "← Sel Prev Track": "← Prev Track Color",
    "→ Sel Next Track": "→ Next Track Color",
    "+ Add Looper": 0,
    "⧀ Prev Looper": "⧀ Prev Looper Track Color",
    "⧁ Next Looper": "⧁ Next Looper Track Color",
    "⇆ Page 1/2": "⇆ Page Color",
    "⇆ Page 1/3": "⇆ Page Color",
    "⌻ Arm Looper Track": "⌻  Looper Track Arm",
    "⌧ Mute Looper Track": "⌧ Looper Track Mute",
    "① MIDI Map 1 (Big Button)": "◈ Looper State",
  };

  var cc_values = range(119, 1);
  cc_values.splice(0, 0, 'Num');

  var note_values = range(128, 0);
  note_values.splice(0, 0, 'Num');

  var pc_values = range(128, 0);
  pc_values.splice(0, 0, 'Num');

  var ch_values = range(12, 1);
  ch_values.splice(0, 0, 'Ch');
  var type_values = ['Type', 'Note', 'CC', 'PC'];

  var types = ['cc_select', 'ch_select', 'type_select'];

  var color_values = range(50, 0);
  color_values.splice(0, 0, 'Col.');

  var cell_width = "120px";
  var cell_color = "#000000";
  function range(size, startAt = 0) {
    return [...Array(size).keys()].map(i => i + startAt);
  }
  var NUM_BUTTONS = 6;
  var NUM_SLIDERS = 2;

  function create_bpm_option(div) {
    var divClass = document.getElementsByClassName(div);
    var tempo_checkbox = document.createElement('input');
    tempo_checkbox.type = "checkbox";
    tempo_checkbox.id = "metro";

    var tempo_label = document.createElement('label');
    tempo_label.appendChild(document.createTextNode(' Metronome blinking'));

    tempo_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        sendRawSysex([240, 122, 29, 1, 19, 30, 1, 247]);
        options[0] = 1;
      }
      else {
        sendRawSysex([240, 122, 29, 1, 19, 30, 0, 247]);
        options[0] = 0;
      }
    })
    return ([tempo_checkbox, tempo_label])
  }

  function create_session_box_option(div) {
    var divClass = document.getElementsByClassName(div);
    var session_box_checkbox = document.createElement('input');
    session_box_checkbox.type = "checkbox";
    session_box_checkbox.id = "session_box";

    var session_box_label = document.createElement('label');
    session_box_label.appendChild(document.createTextNode(' Create Session Box'));

    session_box_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
    console.log("off");
        options[1] = 0;
        sendRawSysex([240, 122, 29, 1, 19, 31, 0, 247]);
      }
      else {
    console.log("on");
        options[1] = 1;
        sendRawSysex([240, 122, 29, 1, 19, 31, 1, 247]);
      }
    })
    return ([session_box_checkbox, session_box_label])
  }

  function create_sel(num, options_dict, id, display) {
    var select = document.createElement('select')
    var options_str = "";
    if (!Array.isArray(options_dict)) var options_list = Object.keys(options_dict);
    else options_list = options_dict;
    options_list.forEach(function (option) { options_str += '<option value=' + options_list.indexOf(option) + '>' + option + '</option>'; });
    select.innerHTML = options_str;
    select.num = num;
    select.id = id + num;
    select.onchange = function () { on_select_change(select.num, select.value); };
    return select
  }

  function create_options_table(div) {
    // Creates a row of controls described by the name of the div, the number of controls,
    // the offset number of the first control and the type of control
    var divClass = document.getElementsByClassName(div);
    var optionsTable = document.createElement('table');
    var optionsTable_row0 = optionsTable.insertRow(0);
    var optionsTable_row1 = optionsTable.insertRow(1);
    var options_cell = [document.createElement('td'), document.createElement('td')];
    tempo_option = create_bpm_option("Options");
    session_box_option = create_session_box_option("Options");
    options_cell[0].appendChild(tempo_option[0]);
    options_cell[0].appendChild(tempo_option[1]);
    options_cell[1].appendChild(session_box_option[0]);
    options_cell[1].appendChild(session_box_option[1]);
    optionsTable_row0.appendChild(options_cell[0]);
    optionsTable_row1.appendChild(options_cell[1]);
    divClass[0].appendChild(optionsTable);
  }

  function create_connect_table(div) {
    // Creates a row of controls described by the name of the div, the number of controls,
    // the offset number of the first control and the type of control
    var divClass = document.getElementsByClassName(div);
    var optionsTable = document.createElement('table');
    var optionsTable_row0 = optionsTable.insertRow(0);
    var optionsTable_row1 = optionsTable.insertRow(1);
    var options_cell = [document.createElement('td'), document.createElement('td')];
    var firmware_cell = [document.createElement('td'), document.createElement('td')];
    optionsTable.className = "type1";
  }

  function connect_label() {
    var statusLabel = document.createElement('label');
    statusLabel.id = "Status Label";
    var statusBox = document.getElementsByClassName("Connect Status");
    statusBox[0].appendChild(statusLabel);
  }

  function create_layout_table(div) {
    var divClass = document.getElementsByClassName(div);
    var mainTable = document.createElement('table');
    var mainTable_row0 = mainTable.insertRow(0);
    var mainTable_row1 = mainTable.insertRow(1);
    var main_cell = document.createElement('td');
    var empty_cell = document.createElement('td');
    var main_cell_table = document.createElement('table');
    // var layout_icon_row = main_cell_table.insertRow(-1);
    // var layout_select_row = main_cell_table.insertRow(1);
    var layout_icon_cell = main_cell_table.insertRow(-1).insertCell(0);
    var layout_select_cell = main_cell_table.insertRow(-1).insertCell(0);
    var layout_color_cell = main_cell_table.insertRow(-1).insertCell(0);
    // var layout_color_cell = main_cell_table.insertRow(-1).insertCell(0);
    mainTable.className = "type1";

    layout_icon_cell.innerHTML = "Select Page";
    sel_layout = create_sel(90, layout_actions, 'sel', 'block');
    layout_color_cell.innerHTML = "Page Color ";
    sel_color = create_color_sel(90);

    divClass[0].appendChild(mainTable);
    main_cell.appendChild(layout_icon_cell);
    main_cell.appendChild(sel_layout);
    main_cell.appendChild(layout_color_cell);
    layout_color_cell.appendChild(sel_color);
    mainTable_row0.appendChild(main_cell);
    main_cell.appendChild(empty_cell);
  }

  function create_display_table(div) {
    var divClass = document.getElementsByClassName(div);
    var mainTable = document.createElement('table');
    // var mainRow = document.createElement("tr");
    let mainCell = document.createElement('td');
    var empty_cell = document.createElement('td');

    var display_icon_row = document.createElement("tr");
    let display_icon_cell = document.createElement('td');
    var display_select_row = document.createElement("tr");
    let display_select_cell = document.createElement('td');

    mainTable.className = "type1";

    display_icon_cell.innerHTML = "Display";
    sel_display = create_sel(20, display_actions, 'sel', 'block');

    display_select_cell.appendChild(sel_display);

    display_icon_row.appendChild(display_icon_cell);
    display_select_row.appendChild(display_select_cell);


    mainCell.appendChild(display_icon_row);
    mainCell.appendChild(display_select_row);
    mainTable.appendChild(mainCell);
    mainCell.appendChild(empty_cell);
    divClass[0].appendChild(mainTable);
    // main_cell.appendChild(display_icon_cell);
    // main_cell.appendChild(sel_display);
  }

  function create_main_table(div) {
    // Creates a row of controls described by the name of the div, the number of controls,
    // the offset number of the first control and the type of control
    var divClass = document.getElementsByClassName(div);
    var mainTable = document.createElement('table');
    var mainTable_row0 = mainTable.insertRow(0);
    mainTable.className = "type1";

    for (var i = 0; i < NUM_BUTTONS; i++) {
      // creates the content of each cell of the main table
      let main_cell = document.createElement('td');
      mainTable_row0.className = "columns-container";
      create_main_cell_content(main_cell, i);
      mainTable_row0.appendChild(main_cell);
    }

    divClass[0].appendChild(mainTable);
  }

  function create_color_sel(num) {
    var select = document.createElement('select')
    var options_str = "";
    if (!Array.isArray(color_values)) var options_list = Object.keys(color_values);
    else options_list = color_values;
    options_list.forEach(function (option) { options_str += '<option value=' + options_list.indexOf(option) + '>' + option + '</option>'; });
    select.innerHTML = options_str;
    select.num = num;
    select.id = 'color_sel' + num;
    select.onchange = function () { on_color_change(select.num, select.value, num); };
    return select
  }

  function on_color_change(i, value, datatype) { // callback when the main sel is changed
    // var sel = document.getElementById("sel" + id);
    value = parseInt(value);
     console.log( datatype + " " + i + " " + value);
    // if data comes from Page Color Selector, sned special sysex message
    if (i == 90){
      sendSysex(32+current_layout, value); // send color for Page 1
      options[2+current_layout] = value; //stores color as options 2 to 4
    }
    else{
      sendSysex(17, current_layout, i, value, 1, 16);
      control_number[current_layout][i+12] = value;
      control_channel[current_layout][i+12] = 10;
    }
  }

  function create_main_cell_content(main_cell, i) {
    let main_cell_table = document.createElement('table');
    var num_row = document.createElement("tr");
    let num_cell = document.createElement('td');
    var LED_icon_row = document.createElement("tr");
    let LED_icon_cell = document.createElement('td');
    var LED_sel_row = document.createElement("tr");
    let LED_sel_cell = [document.createElement('td'), document.createElement('td')];
    var short_button_icon_row = document.createElement("tr");
    let short_button_icon_cell = [document.createElement('td'), document.createElement('td')];
    var short_button_sel_row = document.createElement("tr");
    let short_button_sel_cell = [document.createElement('td'), document.createElement('td')];
    var long_button_icon_row = document.createElement("tr");
    let long_button_icon_cell = document.createElement('td');
    var long_button_sel_row = document.createElement("tr");
    let long_button_sel_cell = document.createElement('td');
    let cc_table = main_cell_table.insertRow(-1).insertCell(-1);


    var snap_checkbox = document.createElement('input');
    snap_checkbox.type = "checkbox";
    snap_checkbox.id = "checkbox" + i;

    var snap_label = document.createElement('label');
    snap_label.appendChild(document.createTextNode('Snap'));

    var color_sel = create_color_sel(i);

    snap_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        sendRawSysex([240, 122, 29, 1, 19, 16, current_layout, i, 1, 247]);
        console.log(current_layout, i, 1);
        set_snap_box(i, 1);
      }
      else {
        sendRawSysex([240, 122, 29, 1, 19, 16, current_layout, i, 0, 247]);
        console.log(current_layout, i, 0);
        set_snap_box(i, 0);
      }
    })

    sel_led = create_sel(i + 12, led_actions, 'sel', 'block');
    sel_short_button = create_sel(i, button_actions, 'sel', 'block');
    sel_long_button = create_sel(i + 6, button_actions, 'sel', 'block');
    LED_sel_cell[0].appendChild(sel_led);
    LED_sel_cell[1].appendChild(color_sel);
    short_button_icon_cell[1].appendChild(snap_label);
    short_button_sel_cell[0].appendChild(sel_short_button);
    short_button_sel_cell[1].appendChild(snap_checkbox);
    long_button_sel_cell.appendChild(sel_long_button);

    var img = document.createElement('img');
    switch (i) {
      case 0:
        img.src = "purple_dot.png";
        break;
      case 1:
        img.src = "green_dot.png";
        break;
      case 2:
        img.src = "blue_dot.png";
        break;
      case 3:
        img.src = "yellow_dot.png";
        break;
      case 4:
        img.src = "orange_dot.png";
        break;
      case 5:
        img.src = "pink_dot.png";
        break;
    }
    LED_icon_cell.appendChild(img);

    var long_button_label = document.createElement('label');
    long_button_label.appendChild(document.createTextNode('Long Press'));
    long_button_label.id = "long_button_label" + i;
    num_cell.innerHTML = "<font size=5>" + (i + 1).toString() + "</font>" + "<br><br>Led<br>";
    short_button_icon_cell[0].innerHTML = "Short Press";
    // long_button_icon_cell.innerHTML = "Looong Press";

    LED_icon_row.appendChild(LED_icon_cell);
    num_row.appendChild(num_cell);
    LED_sel_row.appendChild(LED_sel_cell[0]);
    LED_sel_row.appendChild(LED_sel_cell[1]);
    short_button_icon_row.appendChild(short_button_icon_cell[0]);
    short_button_icon_row.appendChild(short_button_icon_cell[1]);
    short_button_sel_row.appendChild(short_button_sel_cell[0]);
    short_button_sel_row.appendChild(short_button_sel_cell[1]);
    long_button_icon_row.appendChild(long_button_label);
    long_button_sel_row.appendChild(long_button_sel_cell);


    main_cell.appendChild(LED_icon_row);
    main_cell.appendChild(num_row);
    main_cell.appendChild(LED_sel_row);
    main_cell.appendChild(short_button_icon_row);
    main_cell.appendChild(short_button_sel_row);
    // main_cell.appendChild(snap_checkbox_row);
    main_cell.appendChild(long_button_icon_row);
    main_cell.appendChild(long_button_sel_row);
    main_cell.appendChild(cc_table);
  }

  function set_snap_box(id, value) {
    var s = document.getElementById("sel" + (id + 6));
    var l = document.getElementById("long_button_label" + (id));
    if (value == 1) {
      s.style.display = "none";
      l.style.display = "none";
    }
    else {
      s.style.display = "block";
      l.style.display = "block";
    }

    snap[current_layout][id] = value;

  }
  
  function create_slider_table(div) {
    // Creates a row of controls described by the name of the div, the number of controls,
    // the offset number of the first control and the type of control
    var divClass = document.getElementsByClassName(div);
    var mainTable = document.createElement('table');
    mainTable.className = "type1";
    var mainTable_row0 = mainTable.insertRow(0);

    for (var i = 0; i < NUM_SLIDERS; i++) {
      // creates the content of each cell of the main table
      var main_cell = document.createElement('td');
      var main_cell_table = document.createElement('table');
      create_slider_cell_content(main_cell, main_cell_table, i);
      mainTable_row0.appendChild(main_cell);
    }
    divClass[0].appendChild(mainTable);
  }

  function create_slider_cell_content(main_cell, main_cell_table, i) {
    var num_row = main_cell_table.insertRow(0);
    var num_cell = main_cell_table.insertRow(-1).insertCell(0);
    var cc_table_cell = main_cell_table.insertRow(-1).insertCell(0);

    sel_slider = create_sel(i + 18, slider_actions, 'sel', 'block', 180);
    cc_tab = cc_table_constructor(i);
    cc_table = cc_tab[0];
    cc_select = cc_tab[1];
    ch_select = cc_tab[2];
    type_select = cc_tab[3];
    num_cell.innerHTML = "Slider <br> " + (i + 1).toString() + "</font>";

    main_cell.appendChild(num_cell);
    // main_cell.appendChild(slider_icon_cell);
    main_cell.appendChild(sel_slider);
    main_cell.appendChild(cc_table_cell);
    // mainTable_row0.appendChild(main_cell);
  }

  function on_select_change(id, value) { // callback when the main sel is changed
    var sel = document.getElementById("sel" + id);
    value = parseInt(value);
    console.log(sel + " " + id + " " + value);
    if (id == 90) change_layout(value); //change the layout
    // else {
    if (id < 6) set_short_button(id, value); // if id<12 the sel changed is a button
    else if (id < 12) set_long_button(id, value); // if 12<=id<18 the sel changed is a LED
    else if (id < 18) set_led(id, value); // if 12<=id<18 the sel changed is a LED
    else if (id < 20) set_slider(id, value); // if 18<=id<22 the sel changed is a slider
    if (id == 20) set_display(id, value); // if id=22, the sel changed is the display
    // }
  }

  function set_short_button(id, value) {
    var options_list = Object.keys(button_actions); // retrieves the list of button actions
    cc_to_send = button_actions[options_list[value]]; // gets the cc corresponding to the action selected
    control_number[current_layout][id] = cc_to_send; // stores the cc value in the control_number list
    var s = document.getElementById("sel" + (id + 6));
    var snap = 1;
    s.style.display = "block";
    if (options_list[value] == "① MIDI Map 1 (Big Button)") {
      sendSysex(10, current_layout, id, 1, 0, 16);
      var s = document.getElementById("sel" + (id + 6));
      s.style.display = "none";
    }
    else if (options_list[value] == "② MIDI Map 2 (Clear)") {
      sendSysex(10, current_layout, id, 1, 0, 15);
    }
    else if (options_list[value] == "③ MIDI Map 3 (Free)") {
      sendSysex(10, current_layout, id, 1, 0, 14);
    }
    else if (options_list[value] == "④ MIDI Map 4 (Free)") {
      sendSysex(10, current_layout, id, 1, 0, 13);
    }
    else if (options_list[value] == "⑤ MIDI Map 5 (Free)") {
      sendSysex(10, current_layout, id, 1, 0, 12);
    }
    else if (options_list[value] == "⑥ MIDI Map 6 (Free)") {
      sendSysex(10, current_layout, id, 1, 0, 11);
    }
    else sendSysex(10, current_layout, id, cc_to_send, 1, 16);
    // console.log(current_layout + "sel " + id + " " + cc_to_send);

    var led_options_list = Object.keys(led_actions);
    index = led_options_list.indexOf(led_translator[options_list[value]]);
    led = document.getElementById("sel" + (id + 12));
    var led_cc = led_actions[led_translator[options_list[value]]];
    if (!isNaN(led_cc)) {
      led.value = index;
      // sendSysex(72, current_layout, id, led_cc, 1, 16);
      sendSysex(12, current_layout, id, led_cc, 1, 16);
    }

    // if (options_list[value] == "⇆ Page 1/2" || options_list[value] == "⇆ Page 1/3") { // if it is a Layout switch button, copy to all layouts
    //   for (i = 0; i < 3; i++) {
    //     control_number[i][id] = cc_to_send;
    //     sendSysex(10, i, id, cc_to_send);
    //   }
    // }
  }

  function set_long_button(id, value) {
    var options_list = Object.keys(button_actions); // retrieves the list of button actions
    cc_to_send = button_actions[options_list[value]]; // gets the cc corresponding to the action selected
    control_number[current_layout][id] = cc_to_send; // stores the cc value in the control_number list
    if (options_list[value] == "① MIDI Map 1 (Big Button)") {
      sendSysex(11, current_layout, id - 6, 1, 0, 16);
    }
    else if (options_list[value] == "② MIDI Map 2 (Clear)") { 
      sendSysex(11, current_layout, id - 6, 1, 0, 15);
    }
    else if (options_list[value] == "③ MIDI Map 3 (Free)") { 
      sendSysex(11, current_layout, id - 6, 1, 0, 14);
    }
    else if (options_list[value] == "④ MIDI Map 4 (Free)") { 
      sendSysex(11, current_layout, id - 6, 1, 0, 13);
    }
    else if (options_list[value] == "⑤ MIDI Map 5 (Free)") { 
      sendSysex(11, current_layout, id - 6, 1, 0, 12);
    }
    else if (options_list[value] == "⑥ MIDI Map 6 (Free)") { 
      sendSysex(11, current_layout, id - 6, 1, 0, 11);
    }    

    else sendSysex(11, current_layout, id - 6, cc_to_send, 1, 16);
    // console.log(current_layout + "sel " + id - 6 + " " + cc_to_send);

    // if (options_list[value] == "⇆ Page 1/2" || options_list[value] == "⇆ Page 1/3") { // if it is a Layout switch button, copy to all layouts
    //   for (i = 0; i < 3; i++) {
    //     control_number[i][id] = cc_to_send;
    //     sendSysex(11, i, id - 6, cc_to_send);
    //   }
    // }

  }

  function set_slider(id, value) {
    var options_list = Object.keys(slider_actions)
    cc_to_send = slider_actions[options_list[value]];
    control_number[current_layout][id] = cc_to_send;
    sendSysex(13, current_layout, id - 18, cc_to_send, 1, 16);
  }

  function set_led(id, value) {
    var options_list = Object.keys(led_actions)
    cc_to_send = led_actions[options_list[value]];
    var c = document.getElementById("color_sel" + (id-12));
    if (cc_to_send == 0){
      c.style.display = "block";
      control_channel[current_layout][id] = 10;
    }
    else{
      c.style.display = "none";
    control_number[current_layout][id] = cc_to_send;
      control_channel[current_layout][id] = 16;
    sendSysex(12, current_layout, id - 12, cc_to_send, 1, 16);
    }

  }

  function set_display(id, value) {
    var options_list = Object.keys(display_actions)
    cc_to_send = display_actions[options_list[value]];
    sendSysex(14, current_layout, 1, cc_to_send, 1, 16);
  }

  function change_layout(layout) { // updates all sel when a layout is changed
    current_layout = layout;
    var s = document.getElementById("color_sel90"); // set Page color sel
    s.value = options[2+current_layout]
    for (var i = 0; i < 21; i++) {
      if (i < 12) { // updates buttons
        var s = document.getElementById("sel" + i);
        s.value = get_index(i, button_actions);
        s.style.display = "block";
        if (control_type[current_layout][i] == 0 && control_channel[current_layout][i] == 16) s.value = Object.keys(button_actions).indexOf("① MIDI Map 1 (Big Button)");
        if (control_type[current_layout][i] == 0 && control_channel[current_layout][i] == 15) s.value = Object.keys(button_actions).indexOf("② MIDI Map 2 (Clear)");
        if (control_type[current_layout][i] == 0 && control_channel[current_layout][i] == 14) s.value = Object.keys(button_actions).indexOf("③ MIDI Map 3 (Free)");
        if (control_type[current_layout][i] == 0 && control_channel[current_layout][i] == 13) s.value = Object.keys(button_actions).indexOf("④ MIDI Map 4 (Free)");
        if (control_type[current_layout][i] == 0 && control_channel[current_layout][i] == 12) s.value = Object.keys(button_actions).indexOf("⑤ MIDI Map 5 (Free)");
        if (control_type[current_layout][i] == 0 && control_channel[current_layout][i] == 11) s.value = Object.keys(button_actions).indexOf("⑥ MIDI Map 6 (Free)");
        // if (i<=6 && control_type[current_layout][i-6] == 0 && control_channel[current_layout][i-6] == 16) {
        //   s.style.display = "none";
        // }
      }
      else if (i < 18) { // update LEDs
        var s = document.getElementById("sel" + i);
        var c = document.getElementById("color_sel" + (i-12));
        c.style.display = "none";

        if(control_channel[current_layout][i] == 10){
          s.value = 1;
          s.value = 0;
          c.style.display = "block";
          c.value = control_number[current_layout][i];
        }
        else s.value = get_index(i, led_actions);
        s.style.display = "block";
      }
      else if (i < 20) { // updates sliders
        var s = document.getElementById("sel" + i);
        s.value = get_index(i, slider_actions);
      }
      else if (i == 20) { // updates display
        var s = document.getElementById("sel" + i);
        s.value = get_index(i, display_actions);
      }
    }
    for (var i = 0; i < 6; i++) {
      var s = document.getElementById("checkbox" + i);
      s.checked = snap[current_layout][i];
      set_snap_box(i, snap[current_layout][i]);
    }
  }

  function create_external_MIDI_table(div) {
    var divClass = document.getElementsByClassName(div);
    var external_MIDI_table = document.createElement('table');
    external_MIDI_table.className = "type2";
    var external_MIDI_table_row0 = external_MIDI_table.insertRow(0);
    var external_MIDI_table_row1 = external_MIDI_table.insertRow(1);
    var external_MIDI_table_row2 = external_MIDI_table.insertRow(2);
    var empty_cell = document.createElement('td');
    var empty_cell2 = document.createElement('td');
    external_MIDI_table_row2.appendChild(empty_cell);
    external_MIDI_table_row2.appendChild(empty_cell2);
    empty_cell.style.backgroundColor = "#11ffee00";
    empty_cell.style.border= "0px";
    empty_cell2.style.backgroundColor = "#11ffee00";
    empty_cell2.style.border= "0px";
    
    for (var i = 0; i < 8; i++) {

      var external_MIDI_CC_table = document.createElement('table');
      var external_MIDI_CC_table_row0 = external_MIDI_CC_table.insertRow(0);
      var external_MIDI_CC_table_row1 = external_MIDI_CC_table.insertRow(1);
      var external_MIDI_cell = [document.createElement('td'), document.createElement('td')];

      var external_MIDI_label = document.createElement('label');
      if (i < 6) external_MIDI_label.appendChild(document.createTextNode("Button " + (i + 1)));
      else external_MIDI_label.appendChild(document.createTextNode("Slider " + (i - 5)));
      external_MIDI_cell[0].appendChild(external_MIDI_label);

      // creates the content of each cell of the main table
      var MIDI_cell = document.createElement('td');
      var MIDI_cell_table = document.createElement('table');
      MIDI_cell.className = "type1";

      cc_tab = cc_table_constructor(i);
      cc_table = cc_tab[0];
      cc_select = cc_tab[1];
      ch_select = cc_tab[2];
      type_select = cc_tab[3];
      MIDI_cell_table = cc_table;
      external_MIDI_cell[0].appendChild(MIDI_cell_table);
      external_MIDI_cell[0].appendChild(MIDI_cell);
      if (i < 6) external_MIDI_table_row0.appendChild(external_MIDI_cell[0]);
      else external_MIDI_table_row2.appendChild(external_MIDI_cell[0]);
    }
    // external_MIDI_CC_table_row0.appendChild(external_MIDI_cell[1]);
    divClass[0].appendChild(external_MIDI_table);
  }

  function cc_table_constructor(i) {
    var cc_table = document.createElement('table');
    var cc_table_row0 = cc_table.insertRow(0);
    var cell00 = cc_table_row0.insertCell(0);
    var cell01 = cc_table_row0.insertCell(1);
    var cell02 = cc_table_row0.insertCell(2);
    var cell03 = cc_table_row0.insertCell(3);

    type_sel = create_cc_sel(i, type_values, 'type_select', "none", 55)
    cell00.appendChild(type_sel);
    cc_sel = create_cc_sel(i, cc_values, 'cc_select', "none", 55)
    cell01.appendChild(cc_sel);
    ch_sel = create_cc_sel(i, ch_values, 'ch_select', "none", 55)
    cell02.appendChild(ch_sel);
    var cc_label = document.createElement('label');
    cc_label.innerHTML = " ";
    cell03.appendChild(cc_label);
    return ([cc_table, cc_sel, ch_sel, type_sel]);
  }

  function create_cc_sel(num, options_dict, id, display) {
    var select = document.createElement('select')
    var options_str = "";
    if (!Array.isArray(options_dict)) var options_list = Object.keys(options_dict);
    else options_list = options_dict;
    options_list.forEach(function (option) { options_str += '<option value=' + options_list.indexOf(option) + '>' + option + '</option>'; });
    select.innerHTML = options_str;
    select.num = num;
    select.id = id + num;
    select.onchange = function () { on_cc_change(select.num, select.value, id); };
    return select
  }

  function set_External_MIDI(num, btn_num, btn_chnl, btn_type) {
    var type_sel = document.getElementById("type_select" + num);
    var cc_sel = document.getElementById("cc_select" + num);
    var ch_sel = document.getElementById("ch_select" + num);
    type_sel.value = btn_type;
    cc_sel.value = btn_num;
    ch_sel.value = btn_chnl;

  }

  function on_cc_change(id, value, datatype) { // callback when the main sel is changed
    var sel = document.getElementById("sel" + id);
    value = parseInt(value);
    console.log(sel + " " + datatype + " " + id + " " + value);
    if (datatype == "type_select") sendRawSysex([240, 122, 29, 1, 19, 15, 0, id, value - 1, 247]);
    else if (datatype == "cc_select") sendRawSysex([240, 122, 29, 1, 19, 15, 1, id, value, 247]);
    else if (datatype == "ch_select") sendRawSysex([240, 122, 29, 1, 19, 15, 2, id, value, 247]);
  }

  function get_index(i, action_type) {
    var values_list = Object.values(action_type)
    return values_list.indexOf(control_number[current_layout][i]);
  }

  function send_cc(id, type, cc, ch) {
    button = document.getElementById("sel" + (id));
    var options_list = Object.keys(button_actions)
    if (options_list[button.value] == "Custom MIDI") {
      sendSysex(65, current_layout, id, cc, type, ch_values[ch])
    }
  }



 

  function saveTextAsFile(){
          var textToSave = [];
          var textToSave = [control_type[current_layout], control_number[current_layout], control_channel[current_layout]];
          // document.getElementById("inputTextToSave").value;
          var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
          var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
          var fileNameToSaveAs = document.getElementById("inputFileNameToSaveAs").value;

          var downloadLink = document.createElement("a");
          downloadLink.download = fileNameToSaveAs;
          downloadLink.innerHTML = "Download File";
          downloadLink.href = textToSaveAsURL;
          downloadLink.onclick = destroyClickedElement;
          downloadLink.style.display = "none";
          document.body.appendChild(downloadLink);

          downloadLink.click();
      }

      function destroyClickedElement(event){
          document.body.removeChild(event.target);
      }

    //   tp = [bigArray.slice(0, 20)];
    //           cc = [bigArray.slice(21, 41)];
    //           ch = [bigArray.slice(52, 72)];

    function loadFileAsText(){
          var fileToLoad = document.getElementById("fileToLoad").files[0];
        //   console.log("fileToLoad", fileToLoad)
        var filez
          var bigArray = [];
          const reader = new FileReader()
            reader.onload = event =>  filez = event.target.result
            console.log("filez", filez)
            // console.log("readAsText", reader.readAsText(fileToLoad)) 
            var textFromFileLoaded = reader.readAsText(fileToLoad)
              bigArray = textFromFileLoaded.split("\n");
              console.log("bigArray ", bigArray);
        //   var fileReader = new FileReader();
        //   fileReader.onload = function(fileLoadedEvent)
        //   {console.log("textFromFileLoaded ", fileLoadedEvent.target.result);
        //       var textFromFileLoaded = fileLoadedEvent.target.result;
        //     //   document.getElementById("inputTextToSave").value = textFromFileLoaded;
        //       console.log("textFromFileLoaded ", textFromFileLoaded);
        //       bigArray = textFromFileLoaded.split("\n");
        //       console.log("bigArray ", bigArray);
        //     //   control_type = [[bigArray.slice(0, 24)], [bigArray.slice(25, 49)], [bigArray.slice(50, 74)]];
        //     //   control_number[current_layout] = [[bigArray.slice(75, 99)], [bigArray.slice(100, 124)], [bigArray.slice(125, 149)]];
        //     // control_type[current_layout] = [bigArray.slice(0, 20)];
        //     //   control_number[current_layout] = [bigArray.slice(21, 41)];
        //     //   control_channel[current_layout] = [bigArray.slice(22, 42)];
        //     //   control_channel = [[bigArray.slice(150, 174)], [bigArray.slice(175, 199)], [bigArray.slice(200, 224)]];
        //   };
          receive_Preset();
          // fileReader.readAsText(fileToLoad, "UTF-8");
      }

      function receive_Preset() {
    // control_number = cc;
    console.log("control_number4");
  }

</script>

<html>

<head>
  <link href="styles/style.css" rel="stylesheet" type="text/css">
  <link rel="icon" href="https://opencontrol.me/wp-content/uploads/2021/03/cropped-logo_small-1-192x192.png"
    sizes="192x192" />

</head>
<title>open·control editor</title>
<body>

    <!-- <table>
        <tr>
            <td>Preset name:</td>
            <td><input id="inputFileNameToSaveAs"></input></td>
            <td><button onclick="saveTextAsFile()">Save Preset</button></td>
        </tr>
        <tr>
            <td>Select a Preset:</td>
            <td><input type="file" id="fileToLoad"></td>
            <td><button onclick="loadFileAsText()">Load Preset</button><td>
        </tr>
    </table>
<button onclick="uploadPreset()">Upload to Device</button>  -->


  <left>
    <table class="Top Table" width=1600>
      <tbody>
        <tr>
          <td width=200>
            <div class="Layout">
              <script>create_layout_table("Layout")</script>
            </div>
          </td>
          <td width=780>
            <div class="Options">
              <b>Options</b>
              <br>
              <script>create_options_table("Options")</script>
            </div>
          </td>
          <td className="type2" width=300>
            <br>
            <div class="Connect Status">
              <br>
              <!-- <script>create_connect_table("Connect")</script> -->
            </div>
            <br>
          </td>

          <td className="type2">
            <br>
            <div>
              <br>
              <a href="https://opencontrol.me">
              <img src="https://github.com/KBLiveSolutions/open.control/raw/gh-pages-manual/open_control_logo.png" alt="logo" width="150">
            </a> 
              <br>
              <br>
              <a href="https://kblivesolutions.com">
              <img src="https://kblivesolutions.com/wp-content/uploads/2018/10/KB-LS-logo-transparent-White.png" alt="logo2" width="180">
            </a>
          </div>
            <br>
          </td>

        </tr>
      </tbody>
    </table>
    <br>
    <center>
      <table class="Top Table">
        <tbody>
          <tr>
            <td>
              <div class="Display">
                <center>
                  <br>

                  <script>create_display_table("Display")</script>
                </center>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <center>

        <div class="Buttons Short">
          <br>
          <script>create_main_table("Buttons Short", 0)</script>
        </div>



        <div class="Sliders">
          <br>
          <script>create_slider_table("Sliders")</script>
        </div>

        <hr>
        <!-- <div class="ExternalMIDIOptions">
          <br>
          <script>create_external_MIDI_options_table("ExternalMIDIOptions")</script>
        </div>     -->

        <div class="ExternalMIDI">
          External MIDI
          <br>
          <script>create_external_MIDI_table("ExternalMIDI")</script>
        </div>
        <!-- <script>change_layout(0)</script> -->

</body>

</html>