<!-- # Remote Script to make open¬∑control work with Ableton Live
# Copyright (C) 2021 Pierre-Antoine GRISON
# more info on open¬∑control on http://opencontrol.me

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>. -->


<script>

  var LATEST_FIRMWARE_MAJOR_VERSION = 1
  var LATEST_FIRMWARE_MINOR_VERSION = 0
  
  var NUM_BUTTONS = 6;
  var NUM_LEDS = 6;
  var NUM_SLIDERS = 2;
  var NUM_ENCODERS = 2;
  var NUM_LAYOUTS = 3;

  var button_short_type = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // new Array(NUM_BUTTONS)[NUM_BUTTONS][NUM_LAYOUTS];
  var button_short_control = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  var button_short_channel = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  var button_short_snap = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
console.log("length", button_short_control[1].length)
  var button_long_type = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  var button_long_control = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  var button_long_channel = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));

  var led_type = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_LEDS));
  var led_control = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_LEDS));
  var led_channel = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_LEDS));

  var encoder_short_press_type = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  var encoder_short_press_control = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  var encoder_short_press_channel = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // var encoder_long_press_type = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // var encoder_long_press_control = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // var encoder_long_press_channel = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  var encoder_control = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  var encoder_channel = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  var encoder_hold_control = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  var encoder_hold_channel = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));

  var slider_control = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_SLIDERS));
  var slider_channel = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_SLIDERS));

  var display = [0, 0, 0] // = Array(NUM_LAYOUTS)

  var options = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
  var external_MIDI = [[1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1]]
  //====================== MIDI ==========================

  var midi = null;
  var open_control_input_id = null
  var open_control_output_id = null
  var selected_layout = 0
  var open_control_detected = false
  navigator.requestMIDIAccess({ sysex: true }).then(onMIDISuccess, onMIDIFailure);

  function onMIDIFailure(msg) {
    console.log("Failed to get MIDI access - " + msg);
  }

  function onMIDISuccess(midiAccess) {
    midi = midiAccess;
    console.log("MIDI ready!");
    connect_label();
    midi.onstatechange = function (e) { ConnectEventHandler(e); };

    var inputs = midiAccess.inputs.values();
    for (var input = inputs.next(); input && !input.done; input = inputs.next()) {
      input.value.onmidimessage = MIDIMessageEventHandler;
      haveAtLeastOneDevice = true;
    }
  }

  function ConnectEventHandler(event) {
    // Print information about the (dis)connected MIDI controller
    statusLabel = document.getElementById("Status Label");
    statusLabel.style.color = "red";
    statusLabel.innerHTML = "<b> Please connect open¬∑control </b>";
    midi.outputs.forEach(output => {
      console.log("OUTPUT NAME", output.name);
      sendSysexHandshakeRequest(midi.outputs.get(output.id));
    });
  }

  function sendSysexHandshakeRequest(output) {
    console.log("check")
    if (output.name == "open¬∑control") {
      console.log("YES")
      var requestMessage = [240, 122, 29, 1, 19, 1, 247];
      open_control_output = output;
      open_control_output.send(requestMessage);
      console.log("output", output)
    }
  }

  function onOpenControlDetected(maj_ver, min_ver) {
    midi.outputs.forEach(output => {
      if (!open_control_detected) {
        if (LATEST_FIRMWARE_MINOR_VERSION > min_ver){
        statusLabel.style.color = "#FFA500";
        statusLabel.innerHTML = "<b> open¬∑control detected</b> <br> <a href=https://github.com/KBLiveSolutions/open.control-firmware target=_blank style=color:#FFA500;> new firmware available</a> <br> Current: " + maj_ver + "." + min_ver +"; New: " + LATEST_FIRMWARE_MAJOR_VERSION + "." + LATEST_FIRMWARE_MINOR_VERSION;
        }
        else {
        statusLabel.style.color = "#00FF55";
        statusLabel.innerHTML = "<b> open¬∑control detected</b> <br> firmware version: " + maj_ver + "." + min_ver;
        }
        var requestMessage = [240, 122, 29, 1, 19, 4, 247];
        open_control_detected = true;
        open_control_output.send(requestMessage);
      }
    });
  }


  function MIDIMessageEventHandler(event) {
    if (event.data[1] == 122 && event.data[2] == 29 && event.data[3] == 1 && event.data[4] == 19) {
      if (event.data[5] == 68) {
        console.log("open control detected");
        onOpenControlDetected(event.data[6], event.data[7]);
      }
      // Receiving Data from opencontrol after a Dump request
        var rcvd_layout = event.data[6]; 
        var num = event.data[7];
        var btn_ctrl = event.data[8];
        var btn_chnl = event.data[9];
        var btn_type = event.data[10];
      if (event.data[5] == 10) {
        if (num < NUM_BUTTONS) {
          button_short_type[rcvd_layout][num] = btn_type;
          button_short_control[rcvd_layout][num] = btn_ctrl;
          button_short_channel[rcvd_layout][num] = btn_chnl;
        }
        else {
          encoder_short_press_type[rcvd_layout][num-NUM_BUTTONS] = btn_type;
          encoder_short_press_control[rcvd_layout][num-NUM_BUTTONS] = btn_ctrl;
          encoder_short_press_channel[rcvd_layout][num-NUM_BUTTONS] = btn_chnl;
        }
      }

      else if (event.data[5] == 11) {
        if (num < NUM_BUTTONS) {
          button_long_type[rcvd_layout][num] = btn_type;
          button_long_control[rcvd_layout][num] = btn_ctrl;
          button_long_channel[rcvd_layout][num] = btn_chnl;
        }
      }

      else if (event.data[5] == 16) {
        var btn_snap = event.data[8];
        button_short_snap[rcvd_layout][num] = btn_snap;
      }

      else if (event.data[5] == 12) {
        led_type[rcvd_layout][num] = btn_type;
        led_control[rcvd_layout][num] = btn_ctrl;
        led_channel[rcvd_layout][num] = btn_chnl;
      }

      else if (event.data[5] == 13) {
        slider_control[rcvd_layout][num] = btn_ctrl;
        slider_channel[rcvd_layout][num] = btn_chnl;
      }

      else if (event.data[5] == 14) {
        if (num<2){
        encoder_control[rcvd_layout][num] = btn_ctrl;
        encoder_channel[rcvd_layout][num] = btn_chnl;}
        else{
        encoder_hold_control[rcvd_layout][num-2] = btn_ctrl;
        encoder_hold_channel[rcvd_layout][num-2] = btn_chnl;
        }
      }

      else if (event.data[5] == 15) {
        var rcvd_display = event.data[8];
        console.log("disp", rcvd_layout, rcvd_display)
        display[rcvd_layout] = rcvd_display;
      }
           
      else if (event.data[5] == 17) {
        var rcvd_opt = event.data[7];
        var num = event.data[6];
        options[num] = rcvd_opt;
        if (num == 0) set_bpm_option(rcvd_opt);
        if (num == 1) set_session_box_option(rcvd_opt);
      }

      else if (event.data[5] == 18) {
        set_External_MIDI(num, btn_ctrl, btn_chnl, btn_type + 1);
      }

      if (event.data[5] == 79) {

        var s = document.getElementById("metro");
        s.checked = options[0];
        s = document.getElementById("session_box");
        s.checked = !options[1];
        on_page_select_changed(0);
      }
    }
  }

  function sendSysex(sysex_id, layout, id, value, type, channel) {
    // Sending {240, 122, 29, 1, 19, 10, Layout Number, Button number, Note/CC Number, Type, Channel, 247} changes the corresponding button
    var sysexMessage = [240, 122, 29, 1, 19, sysex_id, layout, id, value, type, channel, 247];
    if (open_control_detected) open_control_output.send(sysexMessage);
  }

  function sendRawSysex(sysex_message) {
    // Sending {{240, 122, 29, 1, 19, 10, Layout Number, Button number, Note/CC Number, Type, Channel, 247} changes the corresponding button
    //var sysexMessage = [240, 122, 29, 1, 19, 10, layout, id, value, 1, 16, 247];
    //var output = midi.outputs.get(open_control_output_id);
    if (open_control_detected) open_control_output.send(sysex_message);
  }

  function uploadPreset() {
    // console.log("control_number2", control_number);
    // for (layout = 0; layout < 3; layout++) {
    //   for (control = 0; control < NUM_CONTROLS - 3; control++) {
    //     sendSysex(layout, control, control_number[layout][control], 1, 16);
    //     // sel = document.getElementById("sel" + control);
    //     // sel.value = Object.values(button_actions).indexOf([control_number[layout][control]]);
    //   }
    //   //sendSysexHandshakeRequest();
    // }

    // // on_page_select_changed(0);
  }


  //====================== JAVASCRIPT ==========================

  var current_layout = 0;
  var NUM_CONTROLS = 25;
  var layout_actions = {
    "Page 1": 0,
    "Page 2": 1,
    "Page 3": 2
  };
  var display_actions = {
    "‚â°  Scene Name": 0,
    "‚¶Ä Track Name": 1,
    "‚äô  Looper Number": 2,
    "‚âî  Variation Number / Device": 3,
    "‚Üæ  Left Marker": 4
  };
  var button_actions = {
    "Off": 0,
    "--- Global ---": 0,
    "‚ñ†/‚ñ∂ Start/Stop": 1,
    "‚ùö‚ñ∂ Continue Playing": 100,
    "‚óè‚óã Metronome": 2,
    "‚§∂ Undo": 4,
    "‚§∑ Redo": 40,
    "‚ñ¢ Capture": 5,
    "‚äï BPM +1": 28,
    "‚äñ BPM -1": 29,
    "‚Ñö MIDI Recording Quantization": 104,
    "‚Üê Re-enable Automation": 41,
    "‚á∂ Back To Arrangement": 42,
    "‚ÆÇ Arr./Session View": 75,
    "Clip/Device View": 76,
    "--- Arrangement ---": 0,
    "‚Üû Jump to 1.1.1": 74,
    "‚áâ Restart From Last Pos.": 103,
    "‚óè Arrangement Rec": 6,
    "‚•Å Arrangement Loop": 7,
    "‚á§ Go to Prev Marker": 9,
    "‚á• Go to Next Marker": 8,
    "‚§ì Add/Delete Marker": 10,
    "‚•Ä Loop to Next Marker": 102,
    "‚åâ Punch In": 38,
    "‚åà Punch Out": 39,
    "--- Session ---": 0,
    "‚óã Session Rec": 11,
    "‚ñ∂ Launch Scene": 13,
    "‚¨Ü Sel Prev Scene": 14,
    "‚¨á Sel Next Scene": 15,
    "‚•¥ Jump to Playing Scene": 16,
    "‚•Ö Insert Scene": 17,
    "‚á¥ Capture and Insert Scene": 43,
    "‚ßà Stop All Clips": 3,
    // "‚ûü Disable Follow Actions": 12,
    "--- Tracks ---": 0,
    "‚Üê Sel Prev Track": 18,
    "‚Üí Sel Next Track": 19,
    "‚ñ∑ Launch Clip": 22,
    "‚Ü≥ Find Empty Slot": 23,
    "‚åß Mute": 24,
    "S Solo": 25,
    "‚åª Arm": 26,
    "‚ñ† Stop": 27,
    "U Fold/Unfold Track": 55,
    "‚òÜ Add Audio Track": 20,
    "‚ú¨ Add MIDI Track": 21,
    "--- Looper ---": 0,
    "‚ßÄ Prev Looper": 48,
    "‚ßÅ Next Looper": 49,
    "‚ë† MIDI Map 1 (Big Button)": 0,
    "‚ë° MIDI Map 2 (Clear)": 0,
    "‚ë¢ MIDI Map 3": 0,
    "‚ë£ MIDI Map 4": 0,
    "‚ë§ MIDI Map 5": 0,
    "‚ë• MIDI Map 6": 0,
    "‚ñ£ Stop Looper": 35,
    "‚åª Arm Looper Track": 30,
    "‚åß Mute Looper Track": 31,
    "‚å∏ Show Looper": 32,
    "+ Add Looper": 47,
    "‚àÖ Clear All": 36,
    "--- Variations ---": 0,
    "‚çá Prev Device": 65,
    "‚çà Next Device": 66,
    "‚åÉ Prev Variation": 67,
    "‚åµ Next Variation": 68,
    "‚ñπ Launch Variation": 69,
    "‚ó¶ Store Variation": 70,
    "‚Ü©Ô∏é Recall Last Used": 72,
    "‚åÅ Randomize Macros": 71,
    "--- Pages ---": 0,
    "‚Ü™ Next Page": 57,
    "‚Ü© Prev Page": 56,
    "Page 1‚áÜ2": 50,
    "Page 1‚áÜ3": 51,
    "--- Custom ---": 0,
    "Custom MIDI": 122
  };
  var led_actions = {
    "Custom Color": 0,
    "--- Global ---": 0,
    "‚ñ†/‚ñ∂ Start/Stop": 1,
    "‚óè‚óã Metronome": 2,
    "‚Üê Re-enable Automation": 41,
    "‚ñ¢ Capture": 5,
    "‚Ñö MIDI Recording Quantization": 104,
    "--- Arrangement ---": 0,
    "‚óè Arrangement Rec": 6,
    "‚•Å Arrangement Loop": 7,
    "‚åâ Punch In": 38,
    "‚åà Punch Out": 39,
    "‚á∂ Back To Arrangement": 42,
    "--- Session ---": 0,
    "‚óã Session Rec": 11,
    "‚ñ∂ Selected Scene Color": 13,
    "‚¨Ü Prev Scene Color": 14,
    "‚¨á Next Scene Color": 15,
    "‚ûü Disable Follow Actions": 12,
    "--- Tracks ---": 0,
    "‚úΩ Selected Track Color": 54,
    "‚Üê Prev Track Color": 18,
    "‚Üí Next Track Color": 19,
    "‚ñ∑ Clip Color": 22,
    "‚åß Mute": 24,
    "S Solo": 25,
    "‚åª Arm": 26,
    "‚ñ† Stop": 27,
    "--- Looper ---": 0,
    "‚ßÄ Prev Looper Track Color": 48,
    "‚ßÅ Next Looper Track Color": 49,
    "‚óà State Selected Looper ": 53,
    "‚åª Track Arm Selected Looper": 30,
    "‚åß Track Mute Selected Looper": 31,
    "‚óà State (LOOPER1)": 77,
    "‚óà State (LOOPER2)": 78,
    "‚óà State (LOOPER3)": 79,
    "‚óà State (LOOPER4)": 80,
    "‚óà State (LOOPER5)": 81,
    "‚óà State (LOOPER6)": 82,
    "--- Pages ---": 0,
    "‚áÜ Page Color": 58,
    "--- Custom ---": 0,
    "Custom MIDI": 122
  };
  var slider_actions = {
    "--- Global ---": 0,
    "‚ü≥ Last Selected Parameter": 73,
    "% Global Groove Amount": 37,
    "üéö Master Volume": 89,
    "üéß Cue Volume": 90,
    "--- Selected Track ---": 0,
    "‚üä Volume": 91,
    "‚ó† Pan": 96,
    "A Send A": 59,
    "B Send B": 60,
    "--- Selected Device ---": 0,
    "‚ë† Parameter 1": 61,
    "‚ë° Parameter 2": 62,
    "‚ë¢ Parameter 3": 63,
    "‚ë£ Parameter 4": 64,
    // "‚ù∂ Device 1 Param 1": 92,
    // "‚ù∑ Device 1 Param 2": 93,
    // "‚ù∏ Device 1 Param 3": 94,
    // "‚ùπ Device 1 Param 4": 95,
    "--- Custom ---": 0,
    "Custom MIDI": 122
  };
  var encoder_actions = {
    "--- Global ---": 0,
    "‚ü≥ Last Selected Parameter": 73,
    "% Global Groove Amount": 37,
    "üéö Master Volume": 89,
    "üéß Cue Volume": 90,
    "¬± BPM +/- 1": 87,
    "‚Üî Track Select": 0,
    "--- Arrangement ---": 0,
    "‚â™‚â´ Skip Fwd/Bckwd": 83,
    "‚§û Loop Position": 84,
    "‚©â Loop Length": 85,
    "‚Üπ Jump to Next/Prev Marker": 88,
    "‚Üî Horizontal Zoom": 99,
    "‚Üî Horizontal Scroll": 99,
    "‚Üï Vertical Zoom": 0,
    "--- Session ---": 0,
    "‚Üï Scene Select": 86,
    "--- Selected Track ---": 0,
    "‚üä Volume": 91,
    "‚ó† Pan": 96,
    "A Send A": 59,
    "B Send B": 60,
    "--- Selected Device ---": 0,
    "‚ë† Parameter 1": 61,
    "‚ë° Parameter 2": 62,
    "‚ë¢ Parameter 3": 63,
    "‚ë£ Parameter 4": 64,
    // "‚ù∂ Device 1 Param 1": 92,
    // "‚ù∑ Device 1 Param 2": 93,
    // "‚ù∏ Device 1 Param 3": 94,
    // "‚ùπ Device 1 Param 4": 95,
    "--- Custom ---": 0,
    "Custom MIDI": 122
  };
  var led_translator = {
    "Off": "Off",
    "‚ñ∂ Launch Scene": "‚ñ∂ Selected Scene Color",
    "‚¨Ü Sel Prev Scene": "‚¨Ü Prev Scene Color",
    "‚¨á Sel Next Scene": "‚¨á Next Scene Color",
    "‚ñ†/‚ñ∂ Start/Stop": "‚ñ†/‚ñ∂ Start/Stop",
    "‚óè‚óã Metronome": "‚óè‚óã Metronome",
    "‚ñ† Stop All Clips": 0,
    "‚óè Arrangement Rec": "‚óè Arrangement Rec",
    "‚•Å Arrangement Loop": "‚•Å Arrangement Loop",
    "‚á• Go to Next Marker": 0,
    "‚á§ Go to Prev Marker": 0,
    "‚§ì Add/Delete Marker": 0,
    "‚óã Session Rec": "‚óã Session Rec",
    "‚ûü Disable Follow Actions": 0,
    "‚ñ∑ Launch Clip": "‚ñ∑ Clip Color",
    "‚Ü≥ Find Empty Slot": 0,
    "‚åß Mute": "‚åß Mute",
    "S Solo": "S Solo",
    "‚åª Arm": "‚åª Arm",
    "‚Üê Sel Prev Track": "‚Üê Prev Track Color",
    "‚Üí Sel Next Track": "‚Üí Next Track Color",
    "+ Add Looper": 0,
    "‚ßÄ Prev Looper": "‚ßÄ Prev Looper Track Color",
    "‚ßÅ Next Looper": "‚ßÅ Next Looper Track Color",
    "‚áÜ Page 1/2": "‚áÜ Page Color",
    "‚áÜ Page 1/3": "‚áÜ Page Color",
    "‚åª Arm Looper Track": "‚åª  Looper Track Arm",
    "‚åß Mute Looper Track": "‚åß Looper Track Mute",
    "‚ë† MIDI Map 1 (Big Button)": "‚óà Looper State",
  };

  var color_names = ["Off", "Blue 1", "Blue 2", "Red 1", "Red 2", "Green 1", "Green 2", "Pink 1", "Pink 2", "Purple 1", "Purple 2", "Yellow 1", "Yellow 2", "Orange 1", "Orange 2", "White 1", "White 2"]
  var colors = [0, 125, 21, 14, 56, 126, 62, 11, 42, 66, 106, 33, 4, 43, 16, 120, 49];
  var cc_values = range(119, 1);
  cc_values.splice(0, 0, 'Num');

  var note_values = range(128, 0);
  note_values.splice(0, 0, 'Num');

  var pc_values = range(128, 0);
  pc_values.splice(0, 0, 'Num');

  var ch_values = range(16, 1);
  ch_values.splice(0, 0, 'Ch');

  var ch_values_custom = range(10, 1);
  ch_values_custom.splice(0, 0, 'Ch');

  var type_values = ['Type', 'Note', 'CC', 'PC'];

  var types = ['cc_select', 'ch_select', 'type_select'];

  var color_values = range(50, 0);
  color_values.splice(0, 0, 'Col.');

  var cell_width = "120px";
  var cell_color = "#000000";
  function range(size, startAt = 0) {
    return [...Array(size).keys()].map(i => i + startAt);
  }

 
  ///////////////////////////////////
  // CREATE TABLES AND FUNCTIONS
  ///////////////////////////////////

  function create_bpm_option(div) {
    var divClass = document.getElementsByClassName(div);
    var tempo_checkbox = document.createElement('input');
    tempo_checkbox.type = "checkbox";
    tempo_checkbox.id = "metro";

    var tempo_label = document.createElement('label');
    tempo_label.appendChild(document.createTextNode(' Metronome blinking'));

    tempo_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        sendRawSysex([240, 122, 29, 1, 19, 30, 0, 1, 247]);
        options[0] = 1;
      }
      else {
        sendRawSysex([240, 122, 29, 1, 19, 30, 0, 0, 247]);
        options[0] = 0;
      }
    })
    return ([tempo_checkbox, tempo_label])
  }

  function create_session_box_option(div) {
    var divClass = document.getElementsByClassName(div);
    var session_box_checkbox = document.createElement('input');
    session_box_checkbox.type = "checkbox";
    session_box_checkbox.id = "session_box";

    var session_box_label = document.createElement('label');
    session_box_label.appendChild(document.createTextNode(' Create Session Box'));

    session_box_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        options[1] = 0;
        sendRawSysex([240, 122, 29, 1, 19, 30, 1, 0, 247]);
      }
      else {
        options[1] = 1;
        sendRawSysex([240, 122, 29, 1, 19, 30, 1, 1, 247]);
      }
    })
    return ([session_box_checkbox, session_box_label])
  }

  function create_midi_thru_option(div) {
    var divClass = document.getElementsByClassName(div);
    var thru_div = document.createElement('div');
    var usb_thru_checkbox = document.createElement('input');
    usb_thru_checkbox.type = "checkbox";
    usb_thru_checkbox.id = "usb_thru_box";
    var usb_thru_label = document.createElement('label');
    usb_thru_label.appendChild(document.createTextNode('USB   '));
    usb_thru_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        options[1] = 0;
        sendRawSysex([240, 122, 29, 1, 19, 25, 1, 247]);
      }
      else {
        options[1] = 1;
        sendRawSysex([240, 122, 29, 1, 19, 25, 0, 247]);
      }
    })
    var midi_out_thru_checkbox = document.createElement('input');
    midi_out_thru_checkbox.type = "checkbox";
    midi_out_thru_checkbox.id = "usb_thru_box";
    var midi_out_thru_label = document.createElement('label');
    midi_out_thru_label.appendChild(document.createTextNode('MIDI Out'));
    midi_out_thru_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        options[1] = 0;
        sendRawSysex([240, 122, 29, 1, 19, 26, 1, 247]);
      }
      else {
        options[1] = 1;
        sendRawSysex([240, 122, 29, 1, 19, 26, 0, 247]);
      }
    })

    thru_div.appendChild(usb_thru_checkbox);
    thru_div.appendChild(usb_thru_label);
    thru_div.appendChild(midi_out_thru_checkbox);
    thru_div.appendChild(midi_out_thru_label);
    return (thru_div)
  }

  function create_led_brightness_option(div) {
    var divClass = document.getElementsByClassName(div);
    var brightness_slider = document.createElement('input');
    brightness_slider.type = 'range';
    brightness_slider.steps = "1";
    brightness_slider.min = "10";
    brightness_slider.max = "127";
    brightness_slider.class = "slider";
    // brightness_slider.id = "brightness_slider";

    var brightness_slider_label = document.createElement('label');
    brightness_slider_label.appendChild(document.createTextNode(' LEDs Brightness'));

    brightness_slider.oninput = function () { on_LEDs_brightness_change(brightness_slider.value); };
    return ([brightness_slider, brightness_slider_label]);
  }

  function create_display_brightness_option(div) {
    var divClass = document.getElementsByClassName(div);
    var display_brightness_slider = document.createElement('input');
    display_brightness_slider.type = 'range';
    display_brightness_slider.steps = "1";
    display_brightness_slider.min = "40";
    display_brightness_slider.max = "127";
    display_brightness_slider.class = "slider";
    // brightness_slider.id = "brightness_slider";

    var display_brightness_slider_label = document.createElement('label');
    display_brightness_slider_label.appendChild(document.createTextNode(' Display Brightness'));
    display_brightness_slider.oninput = function () { on_display_brightness_change(display_brightness_slider.value); };
    return ([display_brightness_slider, display_brightness_slider_label]);
  }

  function create_sel(num, options_dict, id, display) {
    var select = document.createElement('select')
    var options_str = "";
    if (!Array.isArray(options_dict)) var options_list = Object.keys(options_dict);
    else options_list = options_dict;
    options_list.forEach(function (option) { options_str += '<option value=' + options_list.indexOf(option) + '>' + option + '</option>'; });
    select.innerHTML = options_str;
    select.num = num;
    select.id = id + num;
    select.onchange = function () { on_select_change(id, select.num, select.value); };
    select.classList.add('select1');
    return select
  }

  function create_color_sel(num) {
    var select = document.createElement('select')
    var options_str = "";
    color_names.forEach(function (option) { options_str += '<option value=' + color_names.indexOf(option) + '>' + option + '</option>'; });
    select.innerHTML = options_str;
    select.num = num;
    select.id = 'color_sel' + num;
    select.className = 'color_select'
    select.onchange = function () { on_color_change(select.num, select.value, num); };
    return select
  }
 
  function create_layout_table(div) {
    var divClass = document.getElementById(div);
    var mainTable = document.createElement('table');
    var mainTable_row0 = mainTable.insertRow(0);
    var mainTable_row1 = mainTable.insertRow(1);
    var main_cell = document.createElement('td');
    var status_cell = document.createElement('td');
    var main_cell_table = document.createElement('table');
    var layout_icon_cell = main_cell_table.insertRow(-1).insertCell(0);
    var layout_select_cell = main_cell_table.insertRow(-1).insertCell(0);
    var layout_color_cell = main_cell_table.insertRow(-1).insertCell(0);
    mainTable.className = "type_layout";

    layout_icon_cell.innerHTML = "Select Page";
    sel_layout = create_sel(90, layout_actions, 'page', 'block');
    layout_color_cell.innerHTML = "Page LED Color ";
    sel_color = create_color_sel(90);
    layout_icon_cell.className = "layout";

    divClass.appendChild(mainTable);
    main_cell.appendChild(layout_icon_cell);
    main_cell.appendChild(sel_layout);
    main_cell.appendChild(layout_color_cell);
    layout_color_cell.appendChild(sel_color);
    mainTable_row0.appendChild(main_cell);
    var statusLabel = document.createElement('label');
    statusLabel.id = "Status Label";
    status_cell.appendChild(statusLabel);
    mainTable_row1.appendChild(status_cell);
  }

  function create_connect_table(div) {
    // Creates a row of controls described by the name of the div, the number of controls,
    // the offset number of the first control and the type of control
    var divClass = document.getElementsByClassName(div);
    var optionsTable = document.createElement('table');
    var optionsTable_row0 = optionsTable.insertRow(0);
    var optionsTable_row1 = optionsTable.insertRow(1);
    var options_cell = [document.createElement('td'), document.createElement('td')];
    var firmware_cell = [document.createElement('td'), document.createElement('td')];
    optionsTable.className = "type1";
  }

  function connect_label() {
    var statusLabel = document.createElement('label');
    statusLabel.id = "Status Label";
    var statusBox = document.getElementsByClassName("ConnectStatus");
    statusBox[0].appendChild(statusLabel);
  }

  function create_options_table(div) {
    var divClass = document.getElementById(div);
    var optionsTable = document.createElement('table');
    optionsTable.className = "type_options";
    var optionsTable_row0 = optionsTable.insertRow(0);
    var optionsTable_row1 = optionsTable.insertRow(1);
    var optionsTable_row2 = optionsTable.insertRow(2);
    var optionsTable_row3 = optionsTable.insertRow(3);
    var optionsTable_row4 = optionsTable.insertRow(4);
    var optionsTable_row5 = optionsTable.insertRow(5);
    var optionsTable_row6 = optionsTable.insertRow(6);
    text_cell = document.createElement('td')
    text_cell.innerHTML = "Options"
    var options_cell = [document.createElement('td'), document.createElement('td'), document.createElement('td'), document.createElement('td'), document.createElement('td'), document.createElement('td')];
    tempo_option = create_bpm_option("Options");
    session_box_option = create_session_box_option("Options");
    led_brightness_option = create_led_brightness_option("Options");
    display_brightness_option = create_display_brightness_option("Options");
    midi_thru_option = create_midi_thru_option("Options");
    options_cell[0].appendChild(tempo_option[0]);
    options_cell[0].appendChild(tempo_option[1]);
    options_cell[1].appendChild(session_box_option[0]);
    options_cell[1].appendChild(session_box_option[1]);
    options_cell[2].appendChild(led_brightness_option[1]);
    options_cell[2].appendChild(led_brightness_option[0]);
    options_cell[3].appendChild(display_brightness_option[1]);
    options_cell[3].appendChild(display_brightness_option[0]);
    options_cell[4].innerHTML = "Forward MIDI In to:"
    options_cell[5].appendChild(midi_thru_option);

    optionsTable_row0.appendChild(text_cell);
    optionsTable_row1.appendChild(options_cell[0]);
    optionsTable_row2.appendChild(options_cell[1]);
    optionsTable_row3.appendChild(options_cell[2]);
    optionsTable_row4.appendChild(options_cell[3]);
    optionsTable_row5.appendChild(options_cell[4]);
    optionsTable_row6.appendChild(options_cell[5]);
    divClass.appendChild(optionsTable);
  }

  function create_display_table(div) {
    var divClass = document.getElementsByClassName(div);
    var mainTable = document.createElement('table');
    var mainRow = document.createElement("tr");
    mainRow.className = "columns-container";
    let mainCell = document.createElement('td');
    var empty_cell = document.createElement('td');

    var display_icon_row = document.createElement("tr");
    let display_icon_cell = document.createElement('td');
    var display_select_row = document.createElement("tr");
    let display_select_cell = document.createElement('td');

    mainCell.className = "type_display";

    display_icon_cell.innerHTML = "Display";
    sel_display = create_sel(0, display_actions, 'display', 'block');
    sel_display.className = 'display_select'

    display_select_cell.appendChild(sel_display);

    display_icon_row.appendChild(display_icon_cell);
    display_select_row.appendChild(display_select_cell);


    mainCell.appendChild(display_icon_row);
    mainCell.appendChild(display_select_row);
    mainTable.appendChild(mainCell);
    mainCell.appendChild(empty_cell);
    divClass[0].appendChild(mainTable);
    // main_cell.appendChild(display_icon_cell);
    // main_cell.appendChild(sel_display);
  }

  function create_buttons_table(div) {
    // Creates a row of controls described by the name of the div, the number of controls,
    // the offset number of the first control and the type of control
    var divClass = document.getElementsByClassName(div);
    var mainTable = document.createElement('table');
    var mainTable_row0 = mainTable.insertRow(0);

    for (var i = 0; i < NUM_BUTTONS; i++) {
      // creates the content of each cell of the main table
      let main_cell = document.createElement('td');
      mainTable_row0.className = "columns-container";
      create_button_cell_content(main_cell, i);
      mainTable_row0.appendChild(main_cell);
      main_cell.className = "main_cell";
    }

    divClass[0].appendChild(mainTable);
  }

  function create_button_cell_content(main_cell, i) {
    let main_cell_table = document.createElement('table');
    let row = [];
    let cell = [];
    for (var j = 0; j < 10; j++) {
      row[j] = document.createElement("tr");
      cell[j * 2] = document.createElement('td');
      cell[j * 2 + 1] = document.createElement('td');
      cell[j * 2].classList.add("type1");
      cell[j * 2 + 1].classList.add("type1");
    }

    switch (i) {
      case 0:
        cell[0].innerHTML = "<font size=8 color=#A246FE>‚óè</font><br> ________________________";
        break;
      case 1:
        cell[0].innerHTML = "<font size=8 color=#2BE1BD>‚óè</font><br> ________________________";
        break;
      case 2:
        cell[0].innerHTML = "<font size=8 color=#3882E8>‚óè</font><br> ________________________";
        break;
      case 3:
        cell[0].innerHTML = "<font size=8 color=#F9FF33>‚óè</font><br> ________________________";
        break;
      case 4:
        cell[0].innerHTML = "<font size=8 color=#FFA233>‚óè</font><br> ________________________";
        break;
      case 5:
        cell[0].innerHTML = "<font size=8 color=#FF3390>‚óè</font><br> ________________________";
        break;
    }
    cell[0].classList.add("type6");
    cell[0].setAttribute("colspan", "2");
    row[0].appendChild(cell[0]);


    cell[2].innerHTML = "LED";
    cell[2].setAttribute("colspan", "2");
    row[1].appendChild(cell[2]);

    sel_led = create_sel(i, led_actions, 'led', 'block');
    cell[4].appendChild(sel_led);
    color_sel = create_color_sel(i);
    cell[5].appendChild(color_sel);
    cell[5].className = "color_sel";
    row[2].appendChild(cell[4]);
    row[2].appendChild(cell[5]);

    cell[6].innerHTML = "<font size=5>" + (i + 1).toString() + "</font>";
    cell[6].classList.add("main_cell_text");
    cell[6].setAttribute("colspan", "2");
    row[3].appendChild(cell[6]);


    cell[8].innerHTML = "Short Press";
    cell[9].innerHTML = "Snap";
    cell[8].classList.add("type5");
    cell[9].classList.add("type5");
    row[4].appendChild(cell[8]);
    row[4].appendChild(cell[9]);

    sel_short_button = create_sel(i, button_actions, 'short_button', 'block');
    cell[10].appendChild(sel_short_button);

    snap_checkbox = create_snap(i);
    cell[11].appendChild(snap_checkbox);
    row[5].appendChild(cell[10]);
    row[5].appendChild(cell[11]);

    cc_table_short = cc_table_constructor(i, "custom_MIDI_table_short_button");
    cell[12].appendChild(cc_table_short);
    cc_table_short.style.visibility = "hidden";
    row[6].appendChild(cell[12]);

    toggle_checkbox = create_toggle(i);
    cell[13].appendChild(toggle_checkbox);
    // cell[13].innerHTML = "Toggle";
    toggle_checkbox.style.visibility = "hidden";
    row[6].appendChild(cell[13]);

    cell[14].innerHTML = "Long Press";
    cell[14].setAttribute("colspan", "2");
    sel_long_button = create_sel(i, button_actions, 'long_button', 'block');
    cell[16].appendChild(sel_long_button);
    row[7].appendChild(cell[14]);
    row[8].appendChild(cell[16]);

    cc_table_long = cc_table_constructor(i, "custom_MIDI_table_long_button");
    cell[18].appendChild(cc_table_long);
    cell[18].style.visibility = "hidden";
    row[9].appendChild(cell[18]);

    for (var i = 0; i < 10; i++) {
      main_cell.appendChild(row[i]);
    }
  }

  function create_snap(i) {
    var snap = document.createElement('input');
    snap.type = "checkbox";
    snap.id = "checkbox" + i;
    snap.addEventListener('change', (event) => {
      if (event.target.checked) on_snap_changed(i, true);
      else on_snap_changed(i, false);
    })
    return snap;
  }

  function create_toggle(i) {
    var toggle_div = document.createElement('div');
    toggle_div.id = "toggle" + i;
    var toggle = document.createElement('input');
    toggle.type = "checkbox";
    toggle.addEventListener('change', (event) => {
      if (event.target.checked) on_toggle_changed(i, true);
      else on_toggle_changed(i, false);
    })
    var toggle_label = document.createElement('label');
    toggle_label.id = "Toggle";
    toggle_label.appendChild(document.createTextNode('Toggle'));
    toggle_div.appendChild(toggle_label);
    toggle_div.appendChild(toggle);
    return toggle_div;
  }

  function create_encoder_table(div) {

var divClass = document.getElementsByClassName(div);
var mainTable = document.createElement('table');
mainTable.className = "type_encoder";
var mainTable_row0 = mainTable.insertRow(0);

for (var i = 0; i < NUM_ENCODERS; i++) {
  let main_cell = document.createElement('td');
  mainTable_row0.className = "columns-container";
  create_encoder_cell_content(main_cell, i);
  mainTable_row0.appendChild(main_cell);
  main_cell.className = "main_cell";
}

divClass[0].appendChild(mainTable);
}

function create_encoder_cell_content(main_cell, i) {
let main_cell_table = document.createElement('table');
let row = [];
let cell = [];
for (var j = 0; j < 10; j++) {
  row[j] = document.createElement("tr");
  cell[j] = document.createElement('td');
  cell[j].classList.add("type1");
}

cell[0].innerHTML = "Encoder " + (i + 1).toString() + "<br> ________________________</font>";
cell[0].setAttribute("colspan", "2");
row[0].appendChild(cell[0]);
sel_encoder = create_sel(i, encoder_actions, 'encoder', 'block');
cell[1].appendChild(sel_encoder);
row[1].appendChild(cell[1]);

cc_table_encoder = cc_table_constructor(i, "custom_MIDI_table_encoder");
cell[2].appendChild(cc_table_encoder);
cell[2].style.visibility = "hidden";
row[2].appendChild(cell[2]);

cell[3].innerHTML = "Hold and Turn";
row[3].appendChild(cell[3]);

sel_encoder_hold = create_sel(i, encoder_actions, 'encoder_hold', 'block');
cell[4].appendChild(sel_encoder_hold);
row[4].appendChild(cell[4]);

cc_table_encoder_hold = cc_table_constructor(i, "custom_MIDI_table_encoder_hold");
cell[5].appendChild(cc_table_encoder_hold);
cell[5].style.visibility = "hidden";
row[5].appendChild(cell[5]);

cell[6].innerHTML = "Short Press";
cell[6].classList.add("type5");
row[6].appendChild(cell[6]);

sel_short_button = create_sel(i, button_actions, 'encoder_short_press', 'block');
cell[7].appendChild(sel_short_button);
row[7].appendChild(cell[7]);

cc_table_short = cc_table_constructor(i, "custom_MIDI_table_encoder_short_press");
cell[8].appendChild(cc_table_short);
cc_table_short.style.visibility = "hidden";
row[8].appendChild(cell[8]);

// toggle_checkbox = create_toggle(i);
// cell[13].appendChild(toggle_checkbox);
// // cell[13].innerHTML = "Toggle";
// toggle_checkbox.style.visibility = "hidden";
// row[8].appendChild(cell[13]);


for (var i = 0; i < 10; i++) {
  main_cell.appendChild(row[i]);
}
}

function create_slider_table(div) {
var divClass = document.getElementsByClassName(div);
var mainTable = document.createElement('table');
mainTable.className = "type_slider";
var mainTable_row0 = mainTable.insertRow(0);

for (var i = 0; i < NUM_SLIDERS; i++) {
  let main_cell = document.createElement('td');
  mainTable_row0.className = "columns-container";
  create_slider_cell_content(main_cell, i);
  mainTable_row0.appendChild(main_cell);
  main_cell.className = "main_cell";
}
divClass[0].appendChild(mainTable);
}

function create_slider_cell_content(main_cell, i) {
let main_cell_table = document.createElement('table');
let row = [];
let cell = [];
for (var j = 0; j < 5; j++) {
  row[j] = document.createElement("tr");
  cell[j] = document.createElement('td');
  row[j].appendChild(cell[j]);
  cell[j].classList.add("type1");
}

cell[0].innerHTML = "Expression Pedal " + (i + 1).toString() + "</font><br> ____________________";
sel_slider = create_sel(i, slider_actions, 'slider', 'block');
cell[1].appendChild(sel_slider);

cell[3].innerHTML = "____________________<br> Calibrate";
calibrate_min_button = document.createElement("input");
calibrate_min_button.type = "button"
calibrate_min_button.value = "Min."
calibrate_max_button = document.createElement("input");
calibrate_max_button.type = "button"
calibrate_max_button.value = "Max."
cell[4].appendChild(calibrate_min_button);
cell[4].appendChild(calibrate_max_button);
calibrate_min_button.onclick = function() {
  console.log("click ", i)
  sendSysex(27, i, i, 0, 1, 1);
}
calibrate_max_button.onclick = function() {
  console.log("click ", i)
  sendSysex(27, i, i, 1, 1, 1);
}

for (var k = 0; k < 5; k++) {
  main_cell.appendChild(row[k]);
}
}

function create_external_MIDI_table(div) {
    var divClass = document.getElementsByClassName(div);
    var external_MIDI_table = document.createElement('table');
    external_MIDI_table.className = "external_midi_table";
    var external_MIDI_table_row0 = external_MIDI_table.insertRow(0);
    var external_MIDI_table_row1 = external_MIDI_table.insertRow(1);
    var external_MIDI_table_row2 = external_MIDI_table.insertRow(2);
    var empty_cell = document.createElement('td');
    var empty_cell2 = document.createElement('td');
    var empty_cell3 = document.createElement('td');
    external_MIDI_table_row2.appendChild(empty_cell);
    external_MIDI_table_row2.appendChild(empty_cell2);
    external_MIDI_table_row2.appendChild(empty_cell3);
    empty_cell.style.backgroundColor = "#11ffee00";
    empty_cell.style.border = "0px";
    empty_cell2.style.backgroundColor = "#11ffee00";
    empty_cell2.style.border = "0px";
    empty_cell3.style.backgroundColor = "#11ffee00";
    empty_cell3.style.border = "0px";

    for (var i = 0; i < 10; i++) {

      var external_MIDI_CC_table = document.createElement('table');
      var external_MIDI_CC_table_row0 = external_MIDI_CC_table.insertRow(0);
      var external_MIDI_CC_table_row1 = external_MIDI_CC_table.insertRow(1);
      var external_MIDI_cell = [document.createElement('td'), document.createElement('td')];

      var external_MIDI_label = document.createElement('label');
      if (i < 8) external_MIDI_label.appendChild(document.createTextNode("Button " + (i + 1)));
      else external_MIDI_label.appendChild(document.createTextNode("Knob/Slider " + (i - 7)));
      external_MIDI_cell[0].appendChild(external_MIDI_label);

      // creates the content of each cell of the main table
      var MIDI_cell = document.createElement('td');
      var MIDI_cell_table = document.createElement('table');

      cc_tab = cc_table_constructor(i, "external_MIDI");
      MIDI_cell_table = cc_tab;
      external_MIDI_cell[0].appendChild(MIDI_cell_table);
      external_MIDI_cell[0].appendChild(MIDI_cell);
      if (i < 8) external_MIDI_table_row0.appendChild(external_MIDI_cell[0]);
      else external_MIDI_table_row2.appendChild(external_MIDI_cell[0]);
    }
    divClass[0].appendChild(external_MIDI_table);
  }

  function cc_table_constructor(i, id) {
    var cc_table = document.createElement('table');
    var cc_table_row0 = cc_table.insertRow(0);
    var cell00 = cc_table_row0.insertCell(0);
    var cell01 = cc_table_row0.insertCell(1);
    var cell02 = cc_table_row0.insertCell(2);
    var cell03 = cc_table_row0.insertCell(3);

    cc_table.id = id + i;
    console.log(cc_table.id)
    type_sel = create_cc_sel(i, type_values, 'type_select', id);
    // if (id != "external_MIDI") cell00.appendChild(type_sel);
    if (id == "custom_MIDI_table_short_button" || id == "custom_MIDI_table_long_button") cell00.appendChild(type_sel);
    cc_sel = create_cc_sel(i, cc_values, 'cc_select', id);
    cell01.appendChild(cc_sel);
    if (id == "external_MIDI") ch_sel = create_cc_sel(i, ch_values, 'ch_select', id);
    else ch_sel = create_cc_sel(i, ch_values_custom, 'ch_select', id);
    cell02.appendChild(ch_sel);
    var cc_label = document.createElement('label', id);
    cc_label.innerHTML = " ";
    cell03.appendChild(cc_label);
    // return ([cc_table, cc_sel, ch_sel, type_sel]);
    return cc_table;
  }

  function create_cc_sel(num, options_dict, id, source) {
    var select = document.createElement('select')
    var options_str = "";
    if (!Array.isArray(options_dict)) var options_list = Object.keys(options_dict);
    else options_list = options_dict;
    options_list.forEach(function (option) { options_str += '<option value=' + options_list.indexOf(option) + '>' + option + '</option>'; });
    select.innerHTML = options_str;
    select.num = num;
    select.id = source + "_" + id + num;
    // console.log(select.id)
    select.onchange = function () { on_cc_change(select.num, select.value, id, source); };
    return select
  }

  ///////////////////////////////////
  // CALLBACKS
  ///////////////////////////////////

  function on_select_change(id, num, value) {
    console.log("debug1", id, num, value)
    var sel = document.getElementById("sel" + id);
    value = parseInt(value);
    if (id == "page") on_page_select_changed(value);
    if (id == "short_button") set_button(id, num, value);
    else if (id == "long_button") set_button(id, num, value);
    else if (id == "led") set_led(num, value);
    else if (id == "slider") set_slider(num, value);
    else if (id == "encoder") set_encoder(id, num, value);
    else if (id == "encoder_hold") set_encoder(id, num, value);
    else if (id == "encoder_short_press") set_button(id, num, value);
    if (id == "display") set_display(num, value);
  }

  function on_LEDs_brightness_change(value) {
    sendRawSysex([240, 122, 29, 1, 19, 23, value, 247]);
  }

  function on_display_brightness_change(value) {
    sendRawSysex([240, 122, 29, 1, 19, 22, value, 247]);
  }

  function on_color_change(i, value, datatype) { // callback when the main sel is changed
    // var sel = document.getElementById("sel" + id);
    value = parseInt(value);
    value = colors[value];
    // // if data comes from Page Color Selector, sned special sysex message
    // if (i == 90) {
    //   sendSysex(32 + current_layout, value); // send color for Page 1
    //   options[2 + current_layout] = value; //stores color as options 2 to 4
    // }
    // else {
      sendSysex(15, current_layout, i, value, 1, 16);
      led_control[current_layout][i] = value;
      led_channel[current_layout][i] = 10;
    // }
  }

  function on_snap_changed(i, val) {
    if (val) {
      sendRawSysex([240, 122, 29, 1, 19, 11, current_layout, i, 1, 247]);
      set_snap_box(i, 1);
    }
    else {
      sendRawSysex([240, 122, 29, 1, 19, 11, current_layout, i, 0, 247]);
      set_snap_box(i, 0);
    }
  }

  function on_toggle_changed(i, val, button_type) {
      var type = 0;
      if (button_type == "long") type = 1;
    if (val) {
      sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, 1, , type, 247]);
      set_toggle_box(i, 1);
    }
    else {
      sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, 0, type, 247]);
      set_toggle_box(i, 0);
    }
  }

  function on_cc_change(num, value, datatype, source) {
    console.log(num, value, datatype, source)
    // var sel = document.getElementById("sel" + num);
    value = parseInt(value);
    if (source == "external_MIDI") {
      if (datatype == "type_select") {
        sendRawSysex([240, 122, 29, 1, 19, 21, 0, num, value - 1, 247]);
        external_MIDI[num][0] = value - 1;
      }
      else if (datatype == "cc_select") {
        sendRawSysex([240, 122, 29, 1, 19, 21, 1, num, value, 247]);
        external_MIDI[num][1] = value;
      }
      else if (datatype == "ch_select") {
        sendRawSysex([240, 122, 29, 1, 19, 21, 2, num, value, 247]);
        external_MIDI[num][2] = value;
      }
    }
    else {
      if (source == "custom_MIDI_table_short_button"){
      if (datatype == "type_select") button_short_type[current_layout][num] = value - 1;
      else if (datatype == "cc_select") button_short_control[current_layout][num] = value;
      else if (datatype == "ch_select") button_short_channel[current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 10, current_layout, num, button_short_control[current_layout][num], button_short_type[current_layout][num], button_short_channel[current_layout][num], 247]);
      }
      else if (source == "custom_MIDI_table_long_button"){
      if (datatype == "type_select") button_long_type[current_layout][num] = value - 1;
      else if (datatype == "cc_select") button_long_control[current_layout][num] = value;
      else if (datatype == "ch_select") button_long_channel[current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 12, current_layout, num, button_long_control[current_layout][num], button_long_type[current_layout][num], button_long_channel[current_layout][num], 247]);
    }
    else if (source == "custom_MIDI_table_encoder_short_press"){
      if (datatype == "type_select") encoder_short_press_type[current_layout][num] = value - 1;
      else if (datatype == "cc_select") encoder_short_press_control[current_layout][num] = value;
      else if (datatype == "ch_select") encoder_short_press_channel[current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 10, current_layout, num+NUM_BUTTONS, encoder_short_press_control[current_layout][num], encoder_short_press_type[current_layout][num], encoder_short_press_channel[current_layout][num], 247]);
}
    else if (source == "custom_MIDI_table_encoder_long_press"){
      if (datatype == "type_select") encoder_long_press_type[current_layout][num] = value - 1;
      else if (datatype == "cc_select") encoder_long_press_control[current_layout][num] = value;
      else if (datatype == "ch_select") encoder_long_press_channel[current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 12, current_layout, num+NUM_BUTTONS, encoder_long_press_control[current_layout][num], encoder_long_press_type[current_layout][num], encoder_long_press_channel[current_layout][num], 247]);
}
      //Sending {240, 122, 29, 1, 19, 10, Layout Number, Button number, Note/CC Number, Type, Channel, 247}
    }
  }

  ///////////////////////////////////
  // UPDATE SELECTS
  ///////////////////////////////////
 
  
  function set_bpm_option(value) {
    console.log("bpm", value)
    var s = document.getElementById("metro");
    s.value = value;
  }
  
  function set_session_box_option(value) {
    var s = document.getElementById("session_box");
    s.value = value;
  }
  
  function update_button_menus(current_layout, id, i) {
    if (id == 'short_button') {
      control_type = button_short_type[current_layout][i];
      control_channel = button_short_channel[current_layout][i];
      control_number = button_short_control[current_layout][i];
      var s = document.getElementById("checkbox" + i);
      s.checked = button_short_snap[current_layout][i];
      set_snap_box(i, button_short_snap[current_layout][i]);
    }

    if (id == 'long_button') {
      control_type = button_long_type[current_layout][i];
      control_channel = button_long_channel[current_layout][i];
      control_number = button_long_control[current_layout][i];
    }

    if (id == 'encoder_short_press') {
      control_type = encoder_short_press_type[current_layout][i];
      control_channel = encoder_short_press_channel[current_layout][i];
      control_number = encoder_short_press_control[current_layout][i];
    }

    if (id == 'encoder_long_press') {
      control_type = encoder_long_press_type[current_layout][i];
      control_channel = encoder_long_press_channel[current_layout][i];
      control_number = encoder_long_press_control[current_layout][i];
    }

    var s = document.getElementById(id + i);
    s.value = get_index(control_number, button_actions);
    if (control_type == 0 && control_channel == 16) s.value = Object.keys(button_actions).indexOf("‚ë† MIDI Map 1 (Big Button)");
    if (control_type == 0 && control_channel == 15) s.value = Object.keys(button_actions).indexOf("‚ë° MIDI Map 2 (Clear)");
    if (control_type == 0 && control_channel == 14) s.value = Object.keys(button_actions).indexOf("‚ë¢ MIDI Map 3");
    if (control_type == 0 && control_channel == 13) s.value = Object.keys(button_actions).indexOf("‚ë£ MIDI Map 4");
    if (control_type == 0 && control_channel == 12) s.value = Object.keys(button_actions).indexOf("‚ë§ MIDI Map 5");
    if (control_type == 0 && control_channel == 11) s.value = Object.keys(button_actions).indexOf("‚ë• MIDI Map 6");

    if (control_channel < 16) {
      s.value = Object.keys(button_actions).indexOf("Custom MIDI");
      var s1 = document.getElementById("custom_MIDI_table_" + id + i);
      s1.style.visibility = "visible";
      var s2 = document.getElementById("custom_MIDI_table_"+id+"_type_select" + i);
      s2.value = control_type;
      var s3 = document.getElementById("custom_MIDI_table_"+id+"_cc_select" + i);
      s3.value = control_number;
      var s4 = document.getElementById("custom_MIDI_table_"+id+"_ch_select" + i);
      s4.value = control_channel;
      // var s5 = document.getElementById("toggle" + id);
      // s5.style.visibility = "visible";
    }
  }

  function on_page_select_changed(layout) {
    current_layout = layout;
    var s = document.getElementById("color_sel90"); // set Page color sel
    s.value = options[2 + current_layout]

    for (var i = 0; i < NUM_BUTTONS; i++) {
      update_button_menus(current_layout, "short_button", i);
      update_button_menus(current_layout, "long_button", i);
    }
    for (var i = 0; i < NUM_LEDS; i++) { // update LEDs
      var s = document.getElementById("led" + i);
      var c = document.getElementById("color_sel" + (i));
      c.style.display = "none";
      control_type = led_type[current_layout][i];
      control_channel = led_channel[current_layout][i];
      control_number = led_control[current_layout][i];

      if (control_channel == 10) {
        s.value = 1;
        s.value = 0;
        c.style.display = "block";
        c.value = control_number;
      }
      else s.value = get_index(led_control[current_layout][i], led_actions);
      s.style.display = "block";
    }

    for (var i = 0; i < NUM_SLIDERS; i++) { // updates sliders
      var s = document.getElementById("slider" + i);
      s.value = get_index(slider_control[current_layout][i], slider_actions);
    }

    for (var i = 0; i < NUM_ENCODERS; i++) { // updates sliders
      var s = document.getElementById("encoder" + i);
      s.value = get_index(encoder_control[current_layout][i], encoder_actions);
      var s = document.getElementById("encoder_hold" + i);
      s.value = get_index(encoder_hold_control[current_layout][i], encoder_actions);
      update_button_menus(current_layout, "encoder_short_press", i);
    }

    var s = document.getElementById("display0");
    s.value = get_index(display[current_layout], display_actions);
  }

  function set_button(id, num, value) {
    var options_list = Object.keys(button_actions); // retrieves the list of button actions
    cc_to_send = button_actions[options_list[value]]; // gets the cc corresponding to the action selected
    var s = document.getElementById(id + num);
    var snap = 1;
    s.style.display = "block";

    if (id == "short_button") {
      sysex_byte = 10;
      button_short_control[current_layout][num] = cc_to_send;
    }
    else if (id == "long_button") {
      sysex_byte = 12;
      button_long_control[current_layout][num] = cc_to_send;
    }
    else if (id == "encoder_short_press") {
      sysex_byte = 10;
      encoder_short_press_control[current_layout][num] = cc_to_send;
      num = num + NUM_BUTTONS;
    }
    else if (id == "encoder_long_press") {
      sysex_byte = 12;
      encoder_long_press_control[current_layout][num] = cc_to_send;
      num = num + NUM_BUTTONS;
    }
    if (options_list[value] == "‚ë† MIDI Map 1 (Big Button)") {
      sendSysex(sysex_byte, current_layout, num, 1, 0, 16);
      // var s = document.getElementById(id + num);
      // s.style.display = "none";
    }
    else if (options_list[value] == "‚ë° MIDI Map 2 (Clear)") {
      sendSysex(sysex_byte, current_layout, num, 1, 0, 15);
    }
    else if (options_list[value] == "‚ë¢ MIDI Map 3") {
      sendSysex(sysex_byte, current_layout, num, 1, 0, 14);
    }
    else if (options_list[value] == "‚ë£ MIDI Map 4") {
      sendSysex(sysex_byte, current_layout, num, 1, 0, 13);
    }
    else if (options_list[value] == "‚ë§ MIDI Map 5") {
      sendSysex(sysex_byte, current_layout, num, 1, 0, 12);
    }
    else if (options_list[value] == "‚ë• MIDI Map 6") {
      sendSysex(sysex_byte, current_layout, num, 1, 0, 11);
    }
    else sendSysex(sysex_byte, current_layout, num, cc_to_send, 1, 16);

    if (options_list[value] == "Custom MIDI") {
      var s = document.getElementById("custom_MIDI_table_" + id + num);
      s.style.visibility = "visible";
      var s = document.getElementById("toggle" + num);
      s.style.visibility = "visible";
    }
    else {
      var s = document.getElementById("custom_MIDI_table_"+ id + num);
      s.style.visibility = "hidden";
      var s = document.getElementById("toggle" + num);
      s.style.visibility = "hidden";
    }
    if (id == "short_button") {
      var led_options_list = Object.keys(led_actions);
      index = led_options_list.indexOf(led_translator[options_list[value]]);
      led = document.getElementById("led" + (num));
      var led_cc = led_actions[led_translator[options_list[value]]];
      if (!isNaN(led_cc)) {
        led.value = index;
        // sendSysex(72, current_layout, id, led_cc, 1, 16);
        sendSysex(14, current_layout, num, led_cc, 1, 16);
      }
    }
  }

  function set_snap_box(num, value) {
    var s = document.getElementById("long_button" + num);
    var l = document.getElementById("long_button_label" + (num));
    if (value == 1) {
      s.style.display = "none";
      // l.style.display = "none";
    }
    else {
      s.style.display = "block";
      // l.style.display = "block";
    }
    button_short_snap[current_layout][num] = value;
  }

  function set_toggle_box(id, value){

  }

  function set_led(num, value) {
    var options_list = Object.keys(led_actions)
    cc_to_send = led_actions[options_list[value]];
    var c = document.getElementById("color_sel" + (num));
    if (cc_to_send == 0) {
      c.style.display = "block";
      led_channel[current_layout][num] = 10;
    }
    else {
      c.style.display = "none";
      led_control[current_layout][num] = cc_to_send;
      led_channel[current_layout][num] = 16;
      sendSysex(14, current_layout, num, cc_to_send, 1, 16);
    }

  }

  function set_encoder(id, num, value) {
    var options_list = Object.keys(encoder_actions)
    cc_to_send = encoder_actions[options_list[value]];
    if (id == "encoder_hold") {
    encoder_hold_control[current_layout][num] = cc_to_send;
    num = num+2;
    }
    else encoder_control[current_layout][num] = cc_to_send;
    sendSysex(16, current_layout, num, cc_to_send, 1, 16);

    if (options_list[value] == "Custom MIDI") {
      var s = document.getElementById("custom_MIDI_table_" + id + num);
      s.style.visibility = "visible";
    }
    else {
      var s = document.getElementById("custom_MIDI_table_"+ id + num);
      s.style.visibility = "hidden";
    }
  }

  function set_slider(num, value) {
    var options_list = Object.keys(slider_actions)
    cc_to_send = slider_actions[options_list[value]];
    slider_control[current_layout][num] = cc_to_send;
    sendSysex(17, current_layout, num, cc_to_send, 1, 16);
  }

  function set_display(num, value) {
    var options_list = Object.keys(display_actions)
    cc_to_send = display_actions[options_list[value]];
    display[current_layout] = cc_to_send;
    sendSysex(18, current_layout, 1, cc_to_send, 1, 16);
  }

  function set_External_MIDI(num, btn_ctrl, btn_chnl, btn_type) {
    var cc_sel = document.getElementById("external_MIDI_cc_select" + num);
    var ch_sel = document.getElementById("external_MIDI_ch_select" + num);
    console.log("EXT", num, btn_type, btn_ctrl, btn_chnl)
    cc_sel.value = btn_ctrl;
    ch_sel.value = btn_chnl;
    if (num<8){
      var type_sel = document.getElementById("external_MIDI_type_select" + num);
    type_sel.value = btn_type;
    }
    external_MIDI[num] = [btn_type, btn_ctrl, btn_chnl];
  }

  // function send_cc(id, type, cc, ch) {
  //   button = document.getElementById("sel" + (id));
  //   var options_list = Object.keys(button_actions)
  //   if (options_list[button.value] == "Custom MIDI") {
  //     sendSysex(65, current_layout, id, cc, type, ch_values[ch])
  //   }
  // }

  function get_index(control_number, action_type) {
    var values_list = Object.values(action_type)
    return values_list.indexOf(control_number);
  }

 ///////////////////////////////////
  // PRESETS
  ///////////////////////////////////
 
  function saveTextAsFile() {
    // var textToSave = [];
    // var textToSave = [control_type[current_layout], control_number[current_layout], control_channel[current_layout]];
    // // document.getElementById("inputTextToSave").value;
    // var textToSaveAsBlob = new Blob([textToSave], { type: "text/plain" });
    // var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
    // var fileNameToSaveAs = document.getElementById("inputFileNameToSaveAs").value;

    // var downloadLink = document.createElement("a");
    // downloadLink.download = fileNameToSaveAs;
    // downloadLink.innerHTML = "Download File";
    // downloadLink.href = textToSaveAsURL;
    // downloadLink.onclick = destroyClickedElement;
    // downloadLink.style.display = "none";
    // document.body.appendChild(downloadLink);

    // downloadLink.click();
  }

  function destroyClickedElement(event) {
    document.body.removeChild(event.target);
  }

  //   tp = [bigArray.slice(0, 20)];
  //           cc = [bigArray.slice(21, 41)];
  //           ch = [bigArray.slice(52, 72)];

  function loadFileAsText() {
    var fileToLoad = document.getElementById("fileToLoad").files[0];
    //   console.log("fileToLoad", fileToLoad)
    var filez
    var bigArray = [];
    const reader = new FileReader()
    reader.onload = event => filez = event.target.result
    console.log("filez", filez)
    // console.log("readAsText", reader.readAsText(fileToLoad)) 
    var textFromFileLoaded = reader.readAsText(fileToLoad)
    bigArray = textFromFileLoaded.split("\n");
    console.log("bigArray ", bigArray);
    //   var fileReader = new FileReader();
    //   fileReader.onload = function(fileLoadedEvent)
    //   {console.log("textFromFileLoaded ", fileLoadedEvent.target.result);
    //       var textFromFileLoaded = fileLoadedEvent.target.result;
    //     //   document.getElementById("inputTextToSave").value = textFromFileLoaded;
    //       console.log("textFromFileLoaded ", textFromFileLoaded);
    //       bigArray = textFromFileLoaded.split("\n");
    //       console.log("bigArray ", bigArray);
    //     //   control_type = [[bigArray.slice(0, 24)], [bigArray.slice(25, 49)], [bigArray.slice(50, 74)]];
    //     //   control_number[current_layout] = [[bigArray.slice(75, 99)], [bigArray.slice(100, 124)], [bigArray.slice(125, 149)]];
    //     // control_type[current_layout] = [bigArray.slice(0, 20)];
    //     //   control_number[current_layout] = [bigArray.slice(21, 41)];
    //     //   control_channel[current_layout] = [bigArray.slice(22, 42)];
    //     //   control_channel = [[bigArray.slice(150, 174)], [bigArray.slice(175, 199)], [bigArray.slice(200, 224)]];
    //   };
    receive_Preset();
    // fileReader.readAsText(fileToLoad, "UTF-8");
  }

  function receive_Preset() {
    // control_number = cc;
    console.log("control_number4");
  }

</script>

<!-- 
///////////////////////////////////
// HTML
/////////////////////////////////// -->

<html>

<head>

  <style>
    :root {
      --radius: 20px;
      --border: 1px;
      --border_color: #000000;
    }

    body {
      background-color: #777777;
      font-family: Helvetica;
      font-size: 100%;
    }

    table {
      /* table-layout: fixed; */
      width: 100%;
      border-collapse: collapse;
      border: 3px none rgb(128, 0, 128);
      color: rgb(231, 231, 231);
      font-family: "Helvetica Neue";
      border-collapse: separate;
      background-color: transparent;
      padding: 0px;
    }

    td {
      border: var(--border) none rgb(19, 170, 39);
      text-align: center;
      width: 50%;
    }

    .columns-container {
      display: table-cell;
      height: 100%;
      width: 20px;
      text-align: center;
    }

    #Options {
      /* width: 500px; */
      width: 33%;
      padding-left: 920px;
      /* padding-top: 10px; */
    }

    div.Sliders {
      align-items: center;
      width: 800px;
      padding-left: 272px;
    }

    div.Encoders {
      align-items: center;
      width: 800px;
      padding-left: 270px;
    }

    div.Display {
      /* align-items: center; */
      /* padding-top: 10px; */
      padding-left: 410px;
      width: 600px;
      text-align: center;
    }

    div.ConnectStatus {
      padding-left: 500px;
      padding-top: 40px;
    }

    td.type_display {
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) solid var(--border_color);
      border-radius: var(--radius);
      height: 18px;
      padding-left: 50px;
      padding-bottom: 25px;
      padding-top: 25px;
    }

    select.display_select {
      color: rgb(0, 0, 0);
      font-family: Helvetica;
      background: rgb(255, 255, 255);
      height: 30px;
      width: 240px;
      padding-left: 5%;
      padding-right: 5%;
      /* font-weight: bold; */
      border-radius: 10px;
    }

    td.layout {
      text-align: center;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) solid rgb(0, 0, 0);
      border-radius: var(--radius);
      height: 18px;
      width: 100px;
      padding-left: 40px;
      padding-right: 5px;
    }

    td.type1 {
      text-align: center;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) solid rgb(0, 0, 0);
      border-radius: var(--radius);
      height: 18px;
      width: 100px;
      padding-left: 2px;
      padding-right: 2px;
      align-items: center;
    }

    td.main_cell {
      text-align: center;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) solid var(--border_color);
      border-radius: var(--radius);
      height: 18px;
      width: 100px;
      /* padding-left: 5px;
  padding-right: 5px; */
      align-items: center;
      padding-bottom: 10px;
    }

    td.color_sel {
      /* text-align: center; */
      border-collapse: separate;
      background: rgb(0, 0, 0);
      /* border-style: none; */
      border: var(--border) none rgb(252, 252, 252);
      height: 18px;
      width: 10px;
      padding-left: 5px;
      padding-right: 5px;
      /* align-items: center; */
    }

    table.type_layout {
      text-align: center;
      float: left;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      /* border-style: none; */
      border: var(--border) solid var(--border_color);
      border-radius: var(--radius);
      height: 18px;
      width: 220px;
      padding-left: 5px;
      padding-right: 5px;
    }

    table.type_options {
      text-align: center;
      float: right;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      /* border-style: none; */
      border: var(--border) solid var(--border_color);
      border-radius: var(--radius);
      height: 18px;
      width: 250px;
      padding-left: 5px;
      padding-right: 5px;
      align-items: center;
    }

    td.type_options {
      text-align: center;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) solid rgb(0, 0, 0);
      border-radius: var(--radius);
      height: 18px;
      width: 100px;
      padding-left: 2px;
      padding-right: 2px;
      align-items: center;
    }

    table.type_encoder {
      float: left;
      text-align: center;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) none rgb(0, 0, 0);
      border-radius: var(--radius);
      height: 18px;
      width: 250px;
      padding-left: 2px;
      padding-right: 2px;
      align-items: center;
      border-collapse: separate;
      background-color: transparent;
    }

    table.type_slider {
      text-align: center;
      float: right;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      /* border-style: none; */
      border: var(--border) solnoneid var(--border_color);
      border-radius: var(--radius);
      height: 18px;
      width: 250px;
      padding-left: 2px;
      padding-right: 2px;
      align-items: center;
      border-collapse: separate;
      background-color: transparent;
    }

    td.main_cell_text {
      text-align: center;
      width: 200px;
      background: rgb(0, 0, 0);
      border: var(--border) none rgb(172, 4, 4);
      column-span: 2;
      width: 120px;
      border-radius: 20px;
      padding-top: 15px;
      height: 60px;
      font-weight: bold;
      font-size: x-large;
      font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }

    table.external_midi_table td {
      border-collapse: separate;
      background: rgb(60, 60, 60);
      border-radius: 0px;
      text-align: center;
      width: 500px;
      padding-top: 5px;
    }

    select.select1 {
      color: rgb(0, 0, 0);
      font-family: Helvetica;
      background: rgb(255, 255, 255);
      height: 30px;
      width: 150px;
      /* font-weight: bold; */
      border-radius: 10px;
    }

    select.color_select {
      color: rgb(0, 0, 0);
      font-family: Helvetica;
      background: rgb(255, 255, 255);
      height: 30px;
      width: 40px;
      padding-left: 5%;
      padding-right: 5%;
      /* font-weight: bold; */
      border-radius: 10px;
    }

    div.ExternalMIDI {
      color: rgb(231, 231, 231);
      font-weight: bold;
      text-align: center;
      padding-top: 360px;
    }

    .slider {
      height: 80px;
      width: 380px;
      background: #fff;
      border-radius: 10px;
      padding: 0 65px 0 45px;
    }
  </style>
</head>
<title>open¬∑control editor</title>

<body>

  <!-- <table>
        <tr>
            <td>Preset name:</td>
            <td><input id="inputFileNameToSaveAs"></input></td>
            <td><button onclick="saveTextAsFile()">Save Preset</button></td>
        </tr>
        <tr>
            <td>Select a Preset:</td>
            <td><input type="file" id="fileToLoad"></td>
            <td><button onclick="loadFileAsText()">Load Preset</button><td>
        </tr>
    </table>
<button onclick="uploadPreset()">Upload to Device</button>  -->


  <div id="Layout">
    <script>create_layout_table("Layout")</script>
  </div>
  <div id="Options">
    <script>create_options_table("Options")</script>
  </div>

  <div class="ConnectStatus">
  </div>


  <div class="Display">
    <script>create_display_table("Display")</script>
  </div>
  <br>

  <div class="buttons_table">
    <script>create_buttons_table("buttons_table", 0)</script>
  </div>
  <br>
  <div class="Encoders">
    <script>create_encoder_table("Encoders")</script>
  </div>
  <div class="Sliders">
    <script>create_slider_table("Sliders")</script>
  </div>
  <br>
  <div class="ExternalMIDI">
    <hr>
    External MIDI
    <br>
    <br>
    <script>create_external_MIDI_table("ExternalMIDI")</script>
  </div>
</body>

</html>
