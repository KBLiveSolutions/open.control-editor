<!-- # WebMIDI Editor for open·control
# Copyright (C) 2021 Pierre-Antoine GRISON
# more info on open·control on http://opencontrol.me

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>. -->


<script>
  var layout_actions = {
    "Page 1": 0,
    "Page 2": 1,
    "Page 3": 2
  };
  var display_actions = {
    "≡  Scene Name": 0,
    "⦀ Track Name": 1,
    "⊙  Looper Number": 2,
    "≔  Variation Number / Device": 3,
    "↾  Left Marker": 4
  };
  var button_actions = {
    "Off": 0,
    "--- Global ---": 0,
    "■/▶ Start/Stop": 1,
    "❚▶ Continue Playing": 100,
    "●○ Metronome": 2,
    "⤶ Undo": 4,
    "⤷ Redo": 40,
    "▢ Capture": 5,
    "⊕ BPM +1": 28,
    "⊖ BPM -1": 29,
    "ℚ MIDI Recording Quantization": 104,
    "← Re-enable Automation": 41,
    "⇶ Back To Arrangement": 42,
    "⮂ Arr./Session View": 75,
    "Clip/Device View": 76,
    "--- Arrangement ---": 0,
    "↞ Jump to 1.1.1": 74,
    "⇉ Restart From Last Pos.": 103,
    "● Arrangement Rec": 6,
    "⥁ Arrangement Loop": 7,
    "⇤ Go to Prev Marker": 9,
    "⇥ Go to Next Marker": 8,
    "⤓ Add/Delete Marker": 10,
    "⥀ Loop to Next Marker": 102,
    "⌉ Punch In": 38,
    "⌈ Punch Out": 39,
    "--- Session ---": 0,
    "○ Session Rec": 11,
    "▶ Launch Scene": 13,
    "⬆ Sel Prev Scene": 14,
    "⬇ Sel Next Scene": 15,
    "⬆+4 Jump 4 Scenes Up": 105,
    "⬇-4 Jump 4 Scenes Down": 106,
    "⥴ Jump to Playing Scene": 16,
    "⥅ Insert Scene": 17,
    "⇴ Capture and Insert Scene": 43,
    "⧈ Stop All Clips": 3,
    // "➟ Disable Follow Actions": 12,
    "--- Tracks ---": 0,
    "← Sel Prev Track": 18,
    "→ Sel Next Track": 19,
    "▷ Launch Clip": 22,
    "↳ Find Empty Slot": 23,
    "⌧ Mute": 24,
    "S Solo": 25,
    "⌻ Arm": 26,
    "■ Stop": 27,
    "U Fold/Unfold Track": 55,
    "☆ Add Audio Track": 20,
    "✬ Add MIDI Track": 21,
    "--- Looper ---": 0,
    "⧀ Prev Looper": 48,
    "⧁ Next Looper": 49,
    "① MIDI Map 1 (Big Button)": 0,
    "② MIDI Map 2 (Clear)": 0,
    "③ MIDI Map 3": 0,
    "④ MIDI Map 4": 0,
    "⑤ MIDI Map 5": 0,
    "⑥ MIDI Map 6": 0,
    // "▣ Stop Looper": 35,
    "⌻ Arm Looper Track": 30,
    "⌧ Mute Looper Track": 31,
    "⌸ Show Looper": 32,
    "+ Add Looper": 47,
    "∅ Clear All": 36,
    "--- Variations ---": 0,
    "⍇ Prev Device": 65,
    "⍈ Next Device": 66,
    "⌃ Prev Variation": 67,
    "⌵ Next Variation": 68,
    "▹ Launch Variation": 69,
    "◦ Store Variation": 70,
    "↩︎ Recall Last Used": 72,
    "⌁ Randomize Macros": 71,
    "--- Pages ---": 0,
    "↪ Next Page": 57,
    "↩ Prev Page": 56,
    "Page 1⇆2": 50,
    "Page 1⇆3": 51,
    "--- Custom ---": 0,
    "Custom MIDI": 122
  };
  var led_actions = {
    "Custom Color": 0,
    "--- Global ---": 0,
    "■/▶ Start/Stop": 1,
    "●○ Metronome": 2,
    "← Re-enable Automation": 41,
    "▢ Capture": 5,
    "ℚ MIDI Recording Quantization": 104,
    "--- Arrangement ---": 0,
    "● Arrangement Rec": 6,
    "⥁ Arrangement Loop": 7,
    "⌉ Punch In": 38,
    "⌈ Punch Out": 39,
    "⇶ Back To Arrangement": 42,
    "--- Session ---": 0,
    "○ Session Rec": 11,
    "▶ Selected Scene Color": 13,
    "⬆ Prev Scene Color": 14,
    "⬇ Next Scene Color": 15,
    "➟ Disable Follow Actions": 12,
    "--- Tracks ---": 0,
    "✽ Selected Track Color": 54,
    "← Prev Track Color": 18,
    "→ Next Track Color": 19,
    "▷ Clip Color": 22,
    "⌧ Mute": 24,
    "S Solo": 25,
    "⌻ Arm": 26,
    "■ Stop": 27,
    "--- Looper ---": 0,
    "⧀ Prev Looper Track Color": 48,
    "⧁ Next Looper Track Color": 49,
    "◈ State Selected Looper ": 53,
    "⌻ Track Arm Selected Looper": 30,
    "⌧ Track Mute Selected Looper": 31,
    "◈ State (LOOPER1)": 77,
    "◈ State (LOOPER2)": 78,
    "◈ State (LOOPER3)": 79,
    "◈ State (LOOPER4)": 80,
    "◈ State (LOOPER5)": 81,
    "◈ State (LOOPER6)": 82,
    // "--- Pages ---": 0,
    // "⇆ Page Color": 58,
    // "--- Custom ---": 0,
    // "Custom MIDI": 122
  };
  var slider_actions = {
    "Off": 0,
    "--- Global ---": 0,
    "⟳ Last Selected Parameter": 73,
    "% Global Groove Amount": 37,
    "🎚 Master Volume": 89,
    "🎧 Cue Volume": 90,
    "--- Selected Track ---": 0,
    "⟊ Volume": 91,
    "◠ Pan": 96,
    "A Send A": 59,
    "B Send B": 60,
    "--- Selected Device ---": 0,
    "① Parameter 1": 61,
    "② Parameter 2": 62,
    "③ Parameter 3": 63,
    "④ Parameter 4": 64,
    // "❶ Device 1 Param 1": 92,
    // "❷ Device 1 Param 2": 93,
    // "❸ Device 1 Param 3": 94,
    // "❹ Device 1 Param 4": 95,
    "--- Custom ---": 0,
    "Custom MIDI": 122
  };
  var encoder_actions = {
    "Off": 0,
    "--- Global ---": 0,
    "⟳ Last Selected Parameter": 73,
    "% Global Groove Amount": 37,
    "🎚 Master Volume": 89,
    "🎧 Cue Volume": 90,
    "± BPM +/- 1": 87,
    "↔ Track Select": 0,
    "--- Arrangement ---": 0,
    "≪≫ Skip Fwd/Bckwd": 83,
    "⤞ Loop Position": 84,
    "⩉ Loop Length": 85,
    "↹ Jump to Next/Prev Marker": 88,
    "↔ Horizontal Zoom": 99,
    "↔ Horizontal Scroll": 99,
    "↕ Vertical Zoom": 0,
    "--- Session ---": 0,
    "↕ Scene Select": 86,
    "--- Selected Track ---": 0,
    "⟊ Volume": 91,
    "◠ Pan": 96,
    "A Send A": 59,
    "B Send B": 60,
    "--- Selected Device ---": 0,
    "① Parameter 1": 61,
    "② Parameter 2": 62,
    "③ Parameter 3": 63,
    "④ Parameter 4": 64,
    // "❶ Device 1 Param 1": 92,
    // "❷ Device 1 Param 2": 93,
    // "❸ Device 1 Param 3": 94,
    // "❹ Device 1 Param 4": 95,
    "--- Custom ---": 0,
    "Custom MIDI": 122
  };
  var led_translator = {
    "Off": "Off",
    "▶ Launch Scene": "▶ Selected Scene Color",
    "⬆ Sel Prev Scene": "⬆ Prev Scene Color",
    "⬇ Sel Next Scene": "⬇ Next Scene Color",
    "■/▶ Start/Stop": "■/▶ Start/Stop",
    "●○ Metronome": "●○ Metronome",
    "■ Stop All Clips": 0,
    "● Arrangement Rec": "● Arrangement Rec",
    "⥁ Arrangement Loop": "⥁ Arrangement Loop",
    "⇥ Go to Next Marker": 0,
    "⇤ Go to Prev Marker": 0,
    "⤓ Add/Delete Marker": 0,
    "○ Session Rec": "○ Session Rec",
    "➟ Disable Follow Actions": 0,
    "▷ Launch Clip": "▷ Clip Color",
    "↳ Find Empty Slot": 0,
    "⌧ Mute": "⌧ Mute",
    "S Solo": "S Solo",
    "⌻ Arm": "⌻ Arm",
    "← Sel Prev Track": "← Prev Track Color",
    "→ Sel Next Track": "→ Next Track Color",
    "+ Add Looper": 0,
    "⧀ Prev Looper": "⧀ Prev Looper Track Color",
    "⧁ Next Looper": "⧁ Next Looper Track Color",
    "⇆ Page 1/2": "⇆ Page Color",
    "⇆ Page 1/3": "⇆ Page Color",
    "⌻ Arm Looper Track": "⌻  Looper Track Arm",
    "⌧ Mute Looper Track": "⌧ Looper Track Mute",
    "① MIDI Map 1 (Big Button)": "◈ Looper State",
  };

  var LATEST_FIRMWARE_MAJOR_VERSION = 1
  var LATEST_FIRMWARE_MINOR_VERSION = 1

  var NUM_BUTTONS = 6;
  var NUM_LEDS = 6;
  var NUM_SLIDERS = 2;
  var NUM_ENCODERS = 2;
  var NUM_LAYOUTS = 3;

  var type = {
   "button_short" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "button_long" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "button_double" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "encoder_short" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS)),
    "led" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_LEDS))
  }

  var control = {
   "button_short" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "button_long" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "button_double" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "encoder_short" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS)),
   "encoder" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS)),
   "encoder_hold" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS)),
   "slider" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_SLIDERS)),
    "led" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_LEDS)),
    "display" : [Array(NUM_LAYOUTS)]
  }

  var channel = {
   "button_short" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "button_long" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "button_double" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "encoder_short" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS)),
   "encoder" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS)),
   "encoder_hold" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS)),
   "slider" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_SLIDERS)),
    "led" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_LEDS))
  }

  var toggle = {
   "button_short" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "button_long" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "button_double" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS)),
   "encoder_short" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS)),
  };

  var snap = {
   "button_short" : [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS))
  };

  sysex_bytes = {
   "button_short" : 10,
   "button_long" : 12,
   "button_double" : 19,
   "encoder_short" : 12,
   "encoder" : 8,
   "encoder_hold" : 9,
   "slider" : 17,
    "led" : 14,
    "snap" : 11,
    "toggle": 13,
    "display": 18,
    "external_MIDI": 21
  };

 var actions = {
   "button_short" : button_actions,
   "button_long" : button_actions,
   "button_double" : button_actions,
   "encoder_short" : button_actions,
   "encoder" : encoder_actions,
   "encoder_hold" : encoder_actions,
   "slider" : slider_actions,
    "led" : led_actions,
    "display": display_actions
  }
  
  // var type["button_short"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var control["button_short"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var channel["button_short"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var toggle["button_short"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var snap["button_short"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var type["button_long"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var control["button_long"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var channel["button_long"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var toggle["button_long"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var type["button_double"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var control["button_double"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var channel["button_double"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));
  // var toggle["button_double"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_BUTTONS));

  // var type["led"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_LEDS));
  // var control["led"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_LEDS));
  // var channel["led"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_LEDS));

  // var type["encoder_short"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // var control["encoder_short"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // var channel["encoder_short"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // // var encoder_long_press_type = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // // var encoder_long_press_control = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // // var encoder_long_press_channel = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // var control["encoder"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // var channel["encoder"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // var control["encoder_hold"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));
  // var channel["encoder_hold"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_ENCODERS));

  // var control["slider"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_SLIDERS));
  // var channel["slider"] = [...Array(NUM_LAYOUTS)].map(e => Array(NUM_SLIDERS));

  var display = [0, 0, 0] // = Array(NUM_LAYOUTS)

  var options = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
  var external_MIDI = [[1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1], [1, 1, 1]]
  //====================== MIDI ==========================

  var midi = null;
  var open_control_output = null
  var open_control_input_id = null
  var open_control_output_id = null
  var selected_layout = 0
  var open_control_detected = false
  var current_layout = 0

  navigator.requestMIDIAccess({ sysex: true }).then(onMIDISuccess, onMIDIFailure);

  function onMIDIFailure(msg) {
    console.log("Failed to get MIDI access - " + msg);
  }

  function onMIDISuccess(midiAccess) {
    midi = midiAccess;
    console.log("MIDI ready!");
    // connect_label();
    midi.onstatechange = function (e) { ConnectEventHandler(e); };
    statusLabel = document.getElementById("Status Label");
    statusLabel.style.color = "#000000";
    var connect_cell = document.getElementById("connect_cell");
    connect_cell.style.backgroundColor = "red";
    statusLabel.innerHTML = "<b> Please connect open·control </b>";

    var inputs = midiAccess.inputs.values();
    for (var input = inputs.next(); input && !input.done; input = inputs.next()) {
      if (input.value.name == "open·control") input.value.onmidimessage = MIDIMessageEventHandler;
      haveAtLeastOneDevice = true;
    }
    // detect_output();
  }

  function ConnectEventHandler(event) {
    // Print information about the (dis)connected MIDI controller
    midi.outputs.forEach(output => {
      // console.log("OUTPUT NAME", output.name);
      if (output.name == "open·control" && !open_control_detected) detect_output(output);
    //   IF OUTPUT = Number of ports and opencontrol not detected {
    //     console.log("not detected")
    //     open_control_detected = false;
    // var connect_cell = document.getElementById("connect_cell");
    // connect_cell.style.backgroundColor = "red";
    // statusLabel.innerHTML = "<b> Please connect open·control </b>";
    //   }

    });
  }

  function detect_output(output) {
    open_control_detected = true
        console.log("send handshake")
        var requestMessage = [240, 122, 29, 1, 19, 1, 247];
        open_control_output = midi.outputs.get(output.id);
        open_control_output.send(requestMessage);
        console.log("output", open_control_output)

  }

  function onOpenControlDetected(maj_ver, min_ver) {
    // midi.outputs.forEach(output => {
        console.log("output2", open_control_output)
        var connect_cell = document.getElementById("connect_cell");
        statusLabel.style.color = "#000000";
        console.log("check")
        if (LATEST_FIRMWARE_MINOR_VERSION > min_ver){
        connect_cell.style.backgroundColor = "#FFA500";
        statusLabel.innerHTML = "<b> open·control detected</b> <br> <a href=https://github.com/KBLiveSolutions/open.control-firmware target=_blank style=color:#000000;> new firmware available</a> <br> Current: " + maj_ver + "." + min_ver +" | New: " + LATEST_FIRMWARE_MAJOR_VERSION + "." + LATEST_FIRMWARE_MINOR_VERSION;
        }
        else {
        connect_cell.style.backgroundColor = "#00FF55";
        statusLabel.innerHTML = "<b> open·control detected</b> <br> firmware version: " + maj_ver + "." + min_ver;
        }
        var requestMessage = [240, 122, 29, 1, 19, 4, 247];
        open_control_detected = true;
        open_control_output.send(requestMessage);
    // });
  }

  function request_Live_update(){
    var requestMessage = [240, 122, 29, 1, 19, 5, 247];
        open_control_output.send(requestMessage);
  }

  function MIDIMessageEventHandler(event) {
    if (event.data[1] == 122 && event.data[2] == 29 && event.data[3] == 1 && event.data[4] == 19) {

      var sysex_byte = event.data[5];

      if (sysex_byte == 68) {
        console.log("open control detected");
        onOpenControlDetected(event.data[6], event.data[7]);
      }

      else { // Receiving Data from opencontrol after a Dump request
        sysex_to_id = {
          10 : "button_short",
          12 : "button_long",
          19 : "button_double",
          //  10 : "encoder_short",
          8 : "encoder",
          18: "display",
          9: "encoder_hold",
          17 : "slider",
          14 : "led",
          11 : "snap",
          13 : "toggle",
          21 : "external_MIDI"
        }

        var rcvd_layout = event.data[6]; 
        var num = event.data[7];
        var id = sysex_to_id[sysex_byte];
        
        if (id=="button_short" || id=="button_long" || id=="button_double" || id=="encoder_short"){
          if (id=="button_short" && num>=NUM_BUTTONS){
            id="encoder_short";
            num = num-NUM_BUTTONS;
          } 
        type[id][rcvd_layout][num] = event.data[10];
        control[id][rcvd_layout][num] = event.data[8];
        channel[id][rcvd_layout][num] = event.data[9];
        }
        if (id=="toggle"){

        }
        if (id=="led" || id=="encoder" || id=="encoder_hold" || id=="slider"){
        control[id][rcvd_layout][num] = event.data[8];
        channel[id][rcvd_layout][num] = event.data[9];
        }

      if (id=="display") {
          control["display"][rcvd_layout] = event.data[8];
        }

        //  else if (sysex_byte == 17) {
        //   var rcvd_opt = event.data[7];
        //   var num = event.data[6];
        //   options[num] = rcvd_opt;
        //   if (num == 0) set_bpm_option(rcvd_opt);
        //   if (num == 1) set_session_box_option(rcvd_opt);
        // }

        // else if (sysex_byte == 18) {
        //   set_External_MIDI(num, btn_ctrl, btn_chnl, btn_type + 1);
        // }

        if (sysex_byte == 79) {

          var s = document.getElementById("metro");
          s.checked = options[0];
          s = document.getElementById("session_box");
          s.checked = !options[1];
        }
      }
      on_page_select_changed(0);
    }
  }

  function show_receive_message(){
      var   message = [240, 122, 29, 1, 19, 54, 3, 7, 82, 69, 67, 69, 73, 86, 69, 247];
      open_control_output.send(message);
  }

  function sendSysex(sysex_id, layout, id, value, type, channel) {
    // Sending {240, 122, 29, 1, 19, 10, Layout Number, Button number, Note/CC Number, Type, Channel, 247} changes the corresponding button
    var sysexMessage = [240, 122, 29, 1, 19, sysex_id, layout, id, value, type, channel, 247];
    if (open_control_detected) open_control_output.send(sysexMessage);
  }

  function sendRawSysex(sysex_message) {
    // Sending {{240, 122, 29, 1, 19, 10, Layout Number, Button number, Note/CC Number, Type, Channel, 247} changes the corresponding button
    //var sysexMessage = [240, 122, 29, 1, 19, 10, layout, id, value, 1, 16, 247];
    //var output = midi.outputs.get(open_control_output_id);
    if (open_control_detected) open_control_output.send(sysex_message);
  }

  //====================== JAVASCRIPT ==========================

  var current_layout = 0;
  var NUM_CONTROLS = 25;

  var color_names = ["Off", "Blue 1", "Blue 2", "Red 1", "Red 2", "Green 1", "Green 2", "Pink 1", "Pink 2", "Purple 1", "Purple 2", "Yellow 1", "Yellow 2", "Orange 1", "Orange 2", "White 1", "White 2"]
  var colors = [0, 125, 21, 14, 56, 126, 62, 11, 42, 66, 106, 33, 4, 43, 16, 120, 49];
  var cc_values = range(119, 1);
  cc_values.splice(0, 0, 'Num');

  var note_values = range(128, 0);
  note_values.splice(0, 0, 'Num');

  var pc_values = range(128, 0);
  pc_values.splice(0, 0, 'Num');

  var ch_values = range(16, 1);
  ch_values.splice(0, 0, 'Ch');

  var ch_values_custom = range(10, 1);
  ch_values_custom.splice(0, 0, 'Ch');

  var type_values = ['Type', 'Note', 'CC', 'PC'];

  var types = ['cc_select', 'ch_select', 'type_select'];

  var color_values = range(50, 0);
  color_values.splice(0, 0, 'Col.');

  var cell_width = "120px";
  var cell_color = "#000000";
  function range(size, startAt = 0) {
    return [...Array(size).keys()].map(i => i + startAt);
  }

 
  ///////////////////////////////////
  // CREATE TABLES AND FUNCTIONS
  ///////////////////////////////////

  function create_options_table(div) {
    var divClass = document.getElementById(div);
    var optionsTable = document.createElement('table');
    optionsTable.className = "type_options";
    var optionsTable_row0 = optionsTable.insertRow(0);
    var optionsTable_row1 = optionsTable.insertRow(1);
    var optionsTable_row2 = optionsTable.insertRow(2);
    text_cell = document.createElement('td')
    text_cell.innerHTML = "Options"
    // text_cell.className = "type_options";
    text_cell.setAttribute("colspan", "4");
    var options_cell = [document.createElement('td'), document.createElement('td'), document.createElement('td'), document.createElement('td'), document.createElement('td'), document.createElement('td'), document.createElement('td'), document.createElement('td'), document.createElement('td')];
    
    for (var i = 0; i < 9; i++) {
    options_cell[i].className = "type_options";
    }

    tempo_option = create_bpm_option("Options");
    session_box_option = create_session_box_option("Options");
    led_brightness_option = create_led_brightness_option("Options");
    display_brightness_option = create_display_brightness_option("Options");
    midi_thru_option = create_midi_thru_option("Options");
    options_cell[0].appendChild(tempo_option[0]);
    options_cell[0].appendChild(tempo_option[1]);
    options_cell[1].appendChild(session_box_option[0]);
    options_cell[1].appendChild(session_box_option[1]);

    options_cell[2].appendChild(led_brightness_option[1]);
    options_cell[2].appendChild(led_brightness_option[0]);
    options_cell[3].appendChild(display_brightness_option[1]);
    options_cell[3].appendChild(display_brightness_option[0]);
    options_cell[4].innerHTML = "Forward MIDI In to:"
    options_cell[5].appendChild(midi_thru_option);

    // optionsTable_row0.appendChild(text_cell);
    
    var statusLabel = document.createElement('label');
    statusLabel.id = "Status Label";
    options_cell[6].className = "connect_cell";
    options_cell[6].id = "connect_cell";
    options_cell[6].appendChild(statusLabel)
    options_cell[6].setAttribute("rowspan", "2");


    // optionsTable_row1.appendChild(options_cell[7]);
    // optionsTable_row2.appendChild(options_cell[8]);
    optionsTable_row1.appendChild(options_cell[0]);
    optionsTable_row2.appendChild(options_cell[1]);
    optionsTable_row1.appendChild(options_cell[2]);
    optionsTable_row2.appendChild(options_cell[3]);
    optionsTable_row1.appendChild(options_cell[4]);
    optionsTable_row2.appendChild(options_cell[5]);
    optionsTable_row1.appendChild(options_cell[6])
    divClass.appendChild(optionsTable);
  }

  function create_bpm_option(div) {
    var divClass = document.getElementsByClassName(div);
    var tempo_label = document.createElement('label');
    var tempo_checkbox = document.createElement('input');
    tempo_checkbox.type = "checkbox";
    tempo_checkbox.id = "metro";
    tempo_checkbox.className = "demo2"
    tempo_label.htmlFor = tempo_checkbox.id

    tempo_label.appendChild(document.createTextNode(' Metronome blinking'));

    tempo_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        sendRawSysex([240, 122, 29, 1, 19, 30, 0, 1, 247]);
        options[0] = 1;
      }
      else {
        sendRawSysex([240, 122, 29, 1, 19, 30, 0, 0, 247]);
        options[0] = 0;
      }
    })
    return ([tempo_checkbox, tempo_label])
  }

  function create_session_box_option(div) {
    var divClass = document.getElementsByClassName(div);
    var session_box_label = document.createElement('label');
    var session_box_checkbox = document.createElement('input');
    session_box_checkbox.type = "checkbox";
    session_box_checkbox.id = "session_box";
    session_box_checkbox.className = "demo2"
    session_box_label.htmlFor = session_box_checkbox.id

    session_box_label.appendChild(document.createTextNode(' Create Session Box'));

    session_box_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        options[1] = 0;
        sendRawSysex([240, 122, 29, 1, 19, 30, 1, 0, 247]);
      }
      else {
        options[1] = 1;
        sendRawSysex([240, 122, 29, 1, 19, 30, 1, 1, 247]);
      }
    })
    return ([session_box_checkbox, session_box_label])
  }

  function create_led_brightness_option(div) {
    var divClass = document.getElementsByClassName(div);
    var brightness_slider = document.createElement('input');
    brightness_slider.type = 'range';
    brightness_slider.steps = "1";
    brightness_slider.min = "10";
    brightness_slider.max = "127";
    brightness_slider.class = "slider";
    // brightness_slider.id = "brightness_slider";

    var brightness_slider_label = document.createElement('label');
    brightness_slider_label.appendChild(document.createTextNode(' LEDs Brightness'));

    brightness_slider.oninput = function () { on_LEDs_brightness_change(brightness_slider.value); };
    return ([brightness_slider, brightness_slider_label]);
  }

  function create_display_brightness_option(div) {
    var divClass = document.getElementsByClassName(div);
    var display_brightness_slider = document.createElement('input');
    display_brightness_slider.type = 'range';
    display_brightness_slider.steps = "1";
    display_brightness_slider.min = "40";
    display_brightness_slider.max = "127";
    display_brightness_slider.class = "slider";
    // brightness_slider.id = "brightness_slider";

    var display_brightness_slider_label = document.createElement('label');
    display_brightness_slider_label.appendChild(document.createTextNode(' Display Brightness'));
    display_brightness_slider.oninput = function () { on_display_brightness_change(display_brightness_slider.value); };
    return ([display_brightness_slider, display_brightness_slider_label]);
  }

  function create_midi_thru_option(div) {
    var divClass = document.getElementsByClassName(div);
    var usb_thru_div = document.createElement('div');
    var usb_thru_label = document.createElement('label');
    var usb_thru_checkbox = document.createElement('input');
    usb_thru_checkbox.type = "checkbox";
    usb_thru_checkbox.id = "usb_thru_box";
    usb_thru_checkbox.className = "demo2"
    usb_thru_label.htmlFor = usb_thru_checkbox.id
    usb_thru_label.appendChild(document.createTextNode('USB   '));
    usb_thru_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        options[1] = 0;
        sendRawSysex([240, 122, 29, 1, 19, 25, 1, 247]);
      }
      else {
        options[1] = 1;
        sendRawSysex([240, 122, 29, 1, 19, 25, 0, 247]);
      }
    })
    var midi_out_thru_label = document.createElement('label');
    var midi_out_thru_checkbox = document.createElement('input');
    midi_out_thru_checkbox.type = "checkbox";
    midi_out_thru_checkbox.id = "midi_thru_box";
    midi_out_thru_checkbox.className = "demo2"
    midi_out_thru_label.htmlFor = midi_out_thru_checkbox.id
    midi_out_thru_label.appendChild(document.createTextNode('MIDI Out'));
    midi_out_thru_checkbox.addEventListener('change', (event) => {
      if (event.target.checked) {
        options[1] = 0;
        sendRawSysex([240, 122, 29, 1, 19, 26, 1, 247]);
      }
      else {
        options[1] = 1;
        sendRawSysex([240, 122, 29, 1, 19, 26, 0, 247]);
      }
    })

    usb_thru_div.appendChild(usb_thru_checkbox);
    usb_thru_div.appendChild(usb_thru_label);
    usb_thru_div.appendChild(midi_out_thru_checkbox);
    usb_thru_div.appendChild(midi_out_thru_label);
    return (usb_thru_div)
  }

  function create_sel(num, options_dict, id, display) {
    var select = document.createElement('select')
    var options_str = "";
    if (!Array.isArray(options_dict)) var options_list = Object.keys(options_dict);
    else options_list = options_dict;
    options_list.forEach(function (option) { options_str += '<option value=' + options_list.indexOf(option) + '>' + option + '</option>'; });
    select.innerHTML = options_str;
    select.num = num;
    select.id = id + num;
    select.onchange = function () { on_select_change(id, select.num, select.value); };
    select.classList.add('select1');
    return select
  }

  function create_color_sel(num) {
    var select = document.createElement('select')
    var options_str = "";
    color_names.forEach(function (option) { options_str += '<option value=' + color_names.indexOf(option) + '>' + option + '</option>'; });
    select.innerHTML = options_str;
    select.num = num;
    select.id = 'color_sel' + num;
    select.className = 'color_select'
    select.onchange = function () { on_color_change(select.num, select.value, num); };
    return select
  }
 
  function create_layout_table(div) {
    var divClass = document.getElementById(div);
    var mainTable = document.createElement('table');
    divClass.className = "Layout";
    var mainTable_row0 = mainTable.insertRow(0);
    var mainTable_row1 = mainTable.insertRow(1);
    var mainTable_row2 = mainTable.insertRow(2);
    var main_cell = document.createElement('td');
    // var status_cell = document.createElement('td');
    var preset_cell = document.createElement('td');
    var main_cell_table = document.createElement('table');
    var layout_icon_cell = main_cell_table.insertRow(-1).insertCell(0);
    var layout_select_cell = main_cell_table.insertRow(-1).insertCell(0);
    var layout_color_cell = main_cell_table.insertRow(-1).insertCell(0);
    mainTable.className = "type_layout";

    layout_icon_cell.innerHTML = "Select Page";
    sel_layout = create_sel(90, layout_actions, 'page', 'block');
    // layout_color_cell.innerHTML = "Page LED Color ";
    // sel_color = create_color_sel(90);
    layout_icon_cell.className = "layout";

    divClass.appendChild(mainTable);
    main_cell.appendChild(layout_icon_cell);
    main_cell.appendChild(sel_layout);
    // main_cell.appendChild(layout_color_cell);
    // layout_color_cell.appendChild(sel_color);

    preset_cell_content = create_preset_cell("Options");
    preset_cell.appendChild(preset_cell_content);

    mainTable_row0.appendChild(main_cell);

    mainTable_row1.appendChild(preset_cell);
  }

  function create_display_table(div) {
    var divClass = document.getElementsByClassName(div);
    var mainTable = document.createElement('table');
    var mainRow = document.createElement("tr");
    mainRow.className = "columns-container";
    let mainCell = document.createElement('td');
    var empty_cell = document.createElement('td');

    var display_icon_row = document.createElement("tr");
    let display_icon_cell = document.createElement('td');
    var display_select_row = document.createElement("tr");
    let display_select_cell = document.createElement('td');

    mainCell.className = "type_display";

    display_icon_cell.innerHTML = "Display";
    sel_display = create_sel(0, display_actions, 'display', 'block');
    sel_display.className = 'display_select'

    display_select_cell.appendChild(sel_display);

    display_icon_row.appendChild(display_icon_cell);
    display_select_row.appendChild(display_select_cell);


    mainCell.appendChild(display_icon_row);
    mainCell.appendChild(display_select_row);
    mainTable.appendChild(mainCell);
    mainCell.appendChild(empty_cell);
    divClass[0].appendChild(mainTable);
    // main_cell.appendChild(display_icon_cell);
    // main_cell.appendChild(sel_display);
  }

  function create_buttons_table(div) {
    // Creates a row of controls described by the name of the div, the number of controls,
    // the offset number of the first control and the type of control
    var divClass = document.getElementsByClassName(div);
    var mainTable = document.createElement('table');
    var mainTable_row0 = mainTable.insertRow(0);

    for (var i = 0; i < NUM_BUTTONS; i++) {
      // creates the content of each cell of the main table
      let main_cell = document.createElement('td');
      mainTable_row0.className = "columns-container";
      create_button_cell_content(main_cell, i);
      mainTable_row0.appendChild(main_cell);
      main_cell.className = "main_cell";
    }

    divClass[0].appendChild(mainTable);
  }

  function create_button_cell_content(main_cell, i) {
    let main_cell_table = document.createElement('table');
    let row = [];
    let cell = [];
    for (var j = 0; j < 13; j++) {
      row[j] = document.createElement("tr");
      cell[j * 2] = document.createElement('td');
      cell[j * 2 + 1] = document.createElement('td');
      cell[j * 2].classList.add("type1");
      cell[j * 2 + 1].classList.add("type1");
    }

    switch (i) {
      case 0:
        cell[0].innerHTML = "<font size=8 color=#A246FE>●</font><br> ________________________";
        break;
      case 1:
        cell[0].innerHTML = "<font size=8 color=#2BE1BD>●</font><br> ________________________";
        break;
      case 2:
        cell[0].innerHTML = "<font size=8 color=#3882E8>●</font><br> ________________________";
        break;
      case 3:
        cell[0].innerHTML = "<font size=8 color=#F9FF33>●</font><br> ________________________";
        break;
      case 4:
        cell[0].innerHTML = "<font size=8 color=#FFA233>●</font><br> ________________________";
        break;
      case 5:
        cell[0].innerHTML = "<font size=8 color=#FF3390>●</font><br> ________________________";
        break;
    }
    cell[0].classList.add("type6");
    cell[0].setAttribute("colspan", "2");
    row[0].appendChild(cell[0]);


    cell[2].innerHTML = "LED";
    cell[2].setAttribute("colspan", "2");
    row[1].appendChild(cell[2]);

    sel_led = create_sel(i, led_actions, 'led', 'block');
    cell[4].appendChild(sel_led);
    color_sel = create_color_sel(i);
    cell[5].appendChild(color_sel);
    cell[5].className = "color_sel";
    row[2].appendChild(cell[4]);
    row[2].appendChild(cell[5]);

    cell[6].innerHTML = "<font size=5>" + (i + 1).toString() + "</font>";
    cell[6].classList.add("main_cell_text");
    cell[6].setAttribute("colspan", "2");
    row[3].appendChild(cell[6]);


    cell[8].innerHTML = "Short";
    // cell[8].setAttribute("colspan", "2");
    cell[8].classList.add("type5");
    cell[9].classList.add("type5");
    row[4].appendChild(cell[8]);
    row[4].appendChild(cell[9]);

    sel_button_short = create_sel(i, button_actions, 'button_short', 'block');
    cell[10].appendChild(sel_button_short);

    snap_checkbox = create_snap(i);
    cell[11].appendChild(snap_checkbox[0]);
    cell[11].appendChild(snap_checkbox[1]);
    row[5].appendChild(cell[10]);
    row[5].appendChild(cell[11]);

    cc_table_short = custom_MIDI_constructor(i, "custom_MIDI_button_short", "button");
    cell[12].appendChild(cc_table_short);
    cc_table_short.style.visibility = "hidden";
    row[6].appendChild(cell[12]);

    toggle_short_checkbox = create_toggle(i, "custom_MIDI_toggle_button_short");
    cell[13].appendChild(toggle_short_checkbox);
    toggle_short_checkbox.style.visibility = "hidden";
    row[6].appendChild(cell[13]);

    
    var button_long_label = document.createElement('label');
    button_long_label.appendChild(document.createTextNode('Long'));
    button_long_label.id = "button_long_label"+i;
    cell[14].appendChild(button_long_label);
    // cell[14].setAttribute("colspan", "2");
    sel_button_long = create_sel(i, button_actions, 'button_long', 'block');
    cell[16].appendChild(sel_button_long);
    // cell[16].setAttribute("colspan", "2");
    row[7].appendChild(cell[14]);
    row[8].appendChild(cell[16]);

    cc_table_long = custom_MIDI_constructor(i, "custom_MIDI_button_long", "button");
    cell[18].appendChild(cc_table_long);
    cell[18].style.visibility = "hidden";
    row[9].appendChild(cell[18]);

    toggle_short_checkbox = create_toggle(i, "custom_MIDI_toggle_button_long");
    cell[19].appendChild(toggle_short_checkbox);
    toggle_short_checkbox.style.visibility = "hidden";
    row[9].appendChild(cell[19]);


    var button_double_label = document.createElement('label');
    button_double_label.appendChild(document.createTextNode('Double'));
    button_double_label.id = "button_double_label"+i;
    cell[20].appendChild(button_double_label);
    sel_button_double = create_sel(i, button_actions, 'button_double', 'block');
    cell[22].appendChild(sel_button_double);
    row[10].appendChild(cell[20]);
    row[11].appendChild(cell[22]);

    cc_table_double = custom_MIDI_constructor(i, "custom_MIDI_button_double", "button");
    cell[24].appendChild(cc_table_double);
    cell[24].style.visibility = "hidden";
    row[12].appendChild(cell[24]);

    toggle_short_checkbox = create_toggle(i, "custom_MIDI_toggle_button_double");
    cell[25].appendChild(toggle_short_checkbox);
    toggle_short_checkbox.style.visibility = "hidden";
    row[12].appendChild(cell[25]);


    for (var i = 0; i < 13; i++) {
      main_cell.appendChild(row[i]);
    }
  }

  function create_snap(i) {
    var snap_label = document.createElement('label');
    var snap = document.createElement('input');
    snap.type = "checkbox";
    snap.id = "checkbox" + i;
    snap.className = "snap"
    snap_label.htmlFor = snap.id
    snap.addEventListener('change', (event) => {
      if (event.target.checked) on_snap_changed(i, true);
      else on_snap_changed(i, false);
    })
    return [snap, snap_label];
  }

  function create_toggle(i, id) {
    var toggle_div = document.createElement('div');
    toggle_div.id = id + i;
    var toggle_label = document.createElement('label');
    var toggle = document.createElement('input');
    toggle.type = "checkbox";
    toggle.id = id+"_checkbox"+i;
    toggle.className = "toggle"
    toggle_label.htmlFor = toggle.id
    toggle.addEventListener('change', (event) => {
      if (event.target.checked) on_toggle_changed(i, true, id);
      else on_toggle_changed(i, false, id);
    })
    toggle_div.appendChild(toggle);
    toggle_div.appendChild(toggle_label);
    return toggle_div;
  }

function create_encoder_table(div) {

var divClass = document.getElementsByClassName(div);
var mainTable = document.createElement('table');
mainTable.className = "type_encoder";
var mainTable_row0 = mainTable.insertRow(0);

for (var i = 0; i < NUM_ENCODERS; i++) {
  let main_cell = document.createElement('td');
  mainTable_row0.className = "columns-container";
  create_encoder_cell_content(main_cell, i);
  mainTable_row0.appendChild(main_cell);
  main_cell.className = "main_cell";
}

divClass[0].appendChild(mainTable);
}

function create_encoder_cell_content(main_cell, i) {
let main_cell_table = document.createElement('table');
let row = [];
let cell = [];
for (var j = 0; j < 11; j++) {
  row[j] = document.createElement("tr");
  cell[j] = document.createElement('td');
  cell[j].classList.add("type1");
}

cell[0].innerHTML = "Encoder " + (i + 1).toString() + "<br> ________________________</font>";
cell[0].setAttribute("colspan", "2");
row[0].appendChild(cell[0]);
sel_encoder = create_sel(i, encoder_actions, 'encoder', 'block');
cell[1].appendChild(sel_encoder);
row[1].appendChild(cell[1]);

cc_table_encoder = custom_MIDI_constructor(i, "custom_MIDI_encoder", "slider");
cell[2].appendChild(cc_table_encoder);
cell[2].style.visibility = "hidden";
row[2].appendChild(cell[2]);

cell[3].innerHTML = "Hold and Turn";
row[3].appendChild(cell[3]);

sel_encoder_hold = create_sel(i, encoder_actions, 'encoder_hold', 'block');
cell[4].appendChild(sel_encoder_hold);
row[4].appendChild(cell[4]);
cc_table_encoder_hold = custom_MIDI_constructor(i, "custom_MIDI_encoder_hold", "slider");
cell[5].appendChild(cc_table_encoder_hold);
cell[5].style.visibility = "hidden";
row[5].appendChild(cell[5]);

cell[6].innerHTML = "Short Press";
cell[6].classList.add("type5");
row[6].appendChild(cell[6]);

sel_button_short = create_sel(i, button_actions, 'encoder_short', 'block');
cell[7].appendChild(sel_button_short);
row[7].appendChild(cell[7]);

cc_table_encoder_short = custom_MIDI_constructor(i, "custom_MIDI_encoder_short", "button");
cell[8].appendChild(cc_table_encoder_short);
cc_table_encoder_short.style.visibility = "hidden";
row[8].appendChild(cell[8]);

toggle_encoder_short_checkbox = create_toggle(i, "custom_MIDI_toggle_encoder_short");
    cell[9].appendChild(toggle_encoder_short_checkbox);
    toggle_encoder_short_checkbox.style.visibility = "hidden";
    row[8].appendChild(cell[9]);

for (var i = 0; i < 10; i++) {
  main_cell.appendChild(row[i]);
}
}

function create_slider_table(div) {
var divClass = document.getElementsByClassName(div);
var mainTable = document.createElement('table');
mainTable.className = "type_slider";
var mainTable_row0 = mainTable.insertRow(0);

for (var i = 0; i < NUM_SLIDERS; i++) {
  let main_cell = document.createElement('td');
  mainTable_row0.className = "columns-container";
  create_slider_cell_content(main_cell, i);
  mainTable_row0.appendChild(main_cell);
  main_cell.className = "main_cell";
}
divClass[0].appendChild(mainTable);
}

function create_slider_cell_content(main_cell, i) {
let main_cell_table = document.createElement('table');
let row = [];
let cell = [];
for (var j = 0; j < 5; j++) {
  row[j] = document.createElement("tr");
  cell[j] = document.createElement('td');
  row[j].appendChild(cell[j]);
  cell[j].classList.add("type1");
}

cell[0].innerHTML = "Expression Pedal " + (i + 1).toString() + "</font><br>____________________";
sel_slider = create_sel(i, slider_actions, 'slider', 'block');
cell[1].appendChild(sel_slider);

cc_table_slider = custom_MIDI_constructor(i, "custom_MIDI_slider", "slider");
cell[2].appendChild(cc_table_slider);
cell[2].style.visibility = "hidden";
row[2].appendChild(cell[2]);

cell[3].innerHTML = "____________________<br> Calibrate";
calibrate_min_button = document.createElement("input");
calibrate_min_button.type = "button"
calibrate_min_button.value = "Min."
calibrate_max_button = document.createElement("input");
calibrate_max_button.type = "button"
calibrate_max_button.value = "Max."
cell[4].appendChild(calibrate_min_button);
cell[4].appendChild(calibrate_max_button);
calibrate_min_button.onclick = function() {
  console.log("click ", i)
  sendSysex(27, i, i, 0, 1, 1);
}
calibrate_max_button.onclick = function() {
  console.log("click ", i)
  sendSysex(27, i, i, 1, 1, 1);
}

for (var k = 0; k < 5; k++) {
  main_cell.appendChild(row[k]);
}
}

function create_external_MIDI_table(div) {
    var divClass = document.getElementsByClassName(div);
    var external_MIDI_table = document.createElement('table');
    external_MIDI_table.className = "external_midi_table";
    var external_MIDI_table_row0 = external_MIDI_table.insertRow(0);
    var external_MIDI_table_row1 = external_MIDI_table.insertRow(1);
    var external_MIDI_table_row2 = external_MIDI_table.insertRow(2);
    var empty_cell = document.createElement('td');
    var empty_cell2 = document.createElement('td');
    var empty_cell3 = document.createElement('td');
    external_MIDI_table_row2.appendChild(empty_cell);
    external_MIDI_table_row2.appendChild(empty_cell2);
    external_MIDI_table_row2.appendChild(empty_cell3);
    empty_cell.style.backgroundColor = "#11ffee00";
    empty_cell.style.border = "0px";
    empty_cell2.style.backgroundColor = "#11ffee00";
    empty_cell2.style.border = "0px";
    empty_cell3.style.backgroundColor = "#11ffee00";
    empty_cell3.style.border = "0px";

    for (var i = 0; i < 10; i++) {

      var external_MIDI_CC_table = document.createElement('table');
      var external_MIDI_CC_table_row0 = external_MIDI_CC_table.insertRow(0);
      var external_MIDI_CC_table_row1 = external_MIDI_CC_table.insertRow(1);
      var external_MIDI_cell = [document.createElement('td'), document.createElement('td')];

      var external_MIDI_label = document.createElement('label');
      if (i < 8) external_MIDI_label.appendChild(document.createTextNode("Button " + (i + 1)));
      else external_MIDI_label.appendChild(document.createTextNode("Knob/Slider " + (i - 7)));
      external_MIDI_cell[0].appendChild(external_MIDI_label);

      // creates the content of each cell of the main table
      var MIDI_cell = document.createElement('td');
      var MIDI_cell_table = document.createElement('table');

      if (i < 8) cc_tab = custom_MIDI_constructor(i, "external_MIDI", "button");
      else cc_tab = custom_MIDI_constructor(i, "external_MIDI", "slider");
      MIDI_cell_table = cc_tab;
      external_MIDI_cell[0].appendChild(MIDI_cell_table);
      external_MIDI_cell[0].appendChild(MIDI_cell);
      if (i < 8) external_MIDI_table_row0.appendChild(external_MIDI_cell[0]);
      else external_MIDI_table_row2.appendChild(external_MIDI_cell[0]);
    }
    divClass[0].appendChild(external_MIDI_table);
  }

  function custom_MIDI_constructor(i, id, type) {
    var cc_table = document.createElement('table');
    var cc_table_row0 = cc_table.insertRow(0);
    var cell00 = cc_table_row0.insertCell(0);
    var cell01 = cc_table_row0.insertCell(1);
    var cell02 = cc_table_row0.insertCell(2);
    var cell03 = cc_table_row0.insertCell(3);

    cc_table.id = id + i;
    type_sel = create_cc_sel(i, type_values, 'type_select', id);
    // if (id != "external_MIDI") cell00.appendChild(type_sel);
    if (type != "slider") cell00.appendChild(type_sel);
    cc_sel = create_cc_sel(i, cc_values, 'cc_select', id);
    cell01.appendChild(cc_sel);
    if (id == "external_MIDI") ch_sel = create_cc_sel(i, ch_values, 'ch_select', id);
    else ch_sel = create_cc_sel(i, ch_values_custom, 'ch_select', id);
    cell02.appendChild(ch_sel);
    var cc_label = document.createElement('label', id);
    cc_label.innerHTML = " ";
    cell03.appendChild(cc_label);
    // return ([cc_table, cc_sel, ch_sel, type_sel]);
    return cc_table;
  }

  function create_cc_sel(num, options_dict, id, source) {
    var select = document.createElement('select')
    var options_str = "";
    if (!Array.isArray(options_dict)) var options_list = Object.keys(options_dict);
    else options_list = options_dict;
    options_list.forEach(function (option) { options_str += '<option value=' + options_list.indexOf(option) + '>' + option + '</option>'; });
    select.innerHTML = options_str;
    select.num = num;
    select.id = source + "_" + id + num;
    // console.log(select.id)
    select.onchange = function () { on_custom_MIDI_change(select.num, select.value, id, source); };
    return select
  }

  ///////////////////////////////////
  // CALLBACKS
  ///////////////////////////////////


  function on_select_change(id, num, value)  {  // called when any of the Select object changes
    console.log(id)
    if (id == "page") on_page_select_changed(value);  // if the Page Select is changed, just update the UI
    else {  // if any other Select is changed, send a Sysex message to change the corresponding control
      var options_list = Object.keys(actions[id]); // retrieves the list of button actions
      cc_to_send = actions[id][options_list[value]]; // gets the cc corresponding to the action selected
      if (id=="display"){
        control[id][current_layout] = cc_to_send;
        num_to_send = num;
      }
      else {
        control[id][current_layout][num] = cc_to_send;
        channel[id][current_layout][num] = 16;
        type[id][current_layout][num] = 1;
        if(id=="encoder_short") num_to_send = num+2;
        else num_to_send = num;
      } 
      show_receive_message();
      sendSysex(sysex_bytes[id], current_layout, num_to_send, cc_to_send, 1, 16);
      request_Live_update();
    }
  }

  function on_LEDs_brightness_change(value) {
    sendRawSysex([240, 122, 29, 1, 19, 23, value, 247]);
  }

  function on_display_brightness_change(value) {
    sendRawSysex([240, 122, 29, 1, 19, 22, value, 247]);
  }

  function on_color_change(i, value, datatype) { // custom color
    // var sel = document.getElementById("sel" + id);
    value = parseInt(value);
    value = colors[value];
    // // if data comes from Page Color Selector, sned special sysex message
    // if (i == 90) {
    //   sendSysex(32 + current_layout, value); // send color for Page 1
    //   options[2 + current_layout] = value; //stores color as options 2 to 4
    // }
    // else {
      sendSysex(15, current_layout, i, value, 1, 16);
      control["led"][current_layout][i] = value;
      channel["led"][current_layout][i] = 10;
    // }
  }

  function on_snap_changed(i, val) {
    if (val) {
      sendRawSysex([240, 122, 29, 1, 19, 11, current_layout, i, 1, 247]);
      update_snap_box(i, 1);
    }
    else {
      sendRawSysex([240, 122, 29, 1, 19, 11, current_layout, i, 0, 247]);
      update_snap_box(i, 0);
    }
  }

  function on_toggle_changed(i, val, button_type) {
    console.log(i, val, button_type)
      var type = 0;
      if (button_type == "custom_MIDI_toggle_button_long") type = 1;
      else if (button_type == "custom_MIDI_toggle_button_double") type = 2;
    if (val) {
      if (button_type == "custom_MIDI_toggle_button_short"){
        sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, 1, 0, 247]);
        toggle["button_short"][current_layout][i] = 1;
      };
      if (button_type == "custom_MIDI_toggle_button_long"){
        sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, 1, 1, 247]);
        toggle["button_long"][current_layout][i] = 1;
      };      
      if (button_type == "custom_MIDI_toggle_button_double"){
        sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, 1, 2, 247]);
        toggle["button_double"][current_layout][i] = 1;
      };
    }
    else {
      if (button_type == "custom_MIDI_toggle_button_short"){
        sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, 0, 0, 247]);
        toggle["button_short"][current_layout][i] = 0;
      };
      if (button_type == "custom_MIDI_toggle_button_long"){
        sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, 0, 1, 247]);
        toggle["button_long"][current_layout][i] = 0;
      };      
      if (button_type == "custom_MIDI_toggle_button_double"){
        sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, 0, 2, 247]);
        toggle["button_double"][current_layout][i] = 0;
      };
    }
  }

  function on_custom_MIDI_change(num, value, datatype, source) {
    console.log(num, value, datatype, source)
    // var sel = document.getElementById("sel" + num);
    value = parseInt(value);
    if (source == "external_MIDI") {
      if (datatype == "type_select") {
        sendRawSysex([240, 122, 29, 1, 19, 21, 0, num, value - 1, 247]);
        external_MIDI[num][0] = value - 1;
      }
      else if (datatype == "cc_select") {
        sendRawSysex([240, 122, 29, 1, 19, 21, 1, num, value, 247]);
        external_MIDI[num][1] = value;
      }
      else if (datatype == "ch_select") {
        sendRawSysex([240, 122, 29, 1, 19, 21, 2, num, value, 247]);
        external_MIDI[num][2] = value;
      }
    }
    else {
      if (source == "custom_MIDI_button_short"){
      if (datatype == "type_select") type["button_short"][current_layout][num] = value - 1;
      else if (datatype == "cc_select") control["button_short"][current_layout][num] = value;
      else if (datatype == "ch_select") channel["button_short"][current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 10, current_layout, num, control["button_short"][current_layout][num], type["button_short"][current_layout][num], channel["button_short"][current_layout][num], 247]);
      }
      else if (source == "custom_MIDI_button_long"){
      if (datatype == "type_select") type["button_long"][current_layout][num] = value - 1;
      else if (datatype == "cc_select") control["button_long"][current_layout][num] = value;
      else if (datatype == "ch_select") channel["button_long"][current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 12, current_layout, num, control["button_long"][current_layout][num], type["button_long"][current_layout][num], channel["button_long"][current_layout][num], 247]);
    }
      else if (source == "custom_MIDI_button_double"){
      if (datatype == "type_select") type["button_double"][current_layout][num] = value - 1;
      else if (datatype == "cc_select") control["button_double"][current_layout][num] = value;
      else if (datatype == "ch_select") channel["button_double"][current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 19, current_layout, num, control["button_double"][current_layout][num], type["button_double"][current_layout][num], channel["button_double"][current_layout][num], 247]);
    }
    else if (source == "custom_MIDI_encoder_short"){
      if (datatype == "type_select") type["encoder_short"][current_layout][num] = value - 1;
      else if (datatype == "cc_select") control["encoder_short"][current_layout][num] = value;
      else if (datatype == "ch_select") channel["encoder_short"][current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 10, current_layout, num+NUM_BUTTONS, control["encoder_short"][current_layout][num], type["encoder_short"][current_layout][num], channel["encoder_short"][current_layout][num], 247]);
}
else if (source == "custom_MIDI_slider"){
      // if (datatype == "type_select") sli[current_layout][num] = value - 1;
      if (datatype == "cc_select") control["slider"][current_layout][num] = value;
      else if (datatype == "ch_select") channel["slider"][current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 17, current_layout, num, control["slider"][current_layout][num], 1, channel["slider"][current_layout][num], 247]);
}
else if (source == "custom_MIDI_encoder"){
      // if (datatype == "type_select") sli[current_layout][num] = value - 1;
      if (datatype == "cc_select") control["encoder"][current_layout][num] = value;
      else if (datatype == "ch_select") channel["encoder"][current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 16, current_layout, num, control["encoder"][current_layout][num], 1, channel["encoder"][current_layout][num], 247]);
}
else if (source == "custom_MIDI_encoder_hold"){
      // if (datatype == "type_select") sli[current_layout][num] = value - 1;
      if (datatype == "cc_select") control["encoder_hold"][current_layout][num] = value;
      else if (datatype == "ch_select") channel["encoder_hold"][current_layout][num] = value;
      sendRawSysex([240, 122, 29, 1, 19, 16, current_layout, num+2, control["encoder_hold"][current_layout][num], 1, channel["encoder_hold"][current_layout][num], 247]);
}

//Sending {240, 122, 29, 1, 19, 10, Layout Number, Button number, Note/CC Number, Type, Channel, 247}
    }
  }

  
  //////////////////////////////////////////////////////////////////////
  // UPDATE DISPLAY AT STARTUP AND ON PAGE CHANGE
  //////////////////////////////////////////////////////////////////////
 
  
  function set_bpm_option(value) {
    var s = document.getElementById("metro");
    s.value = value;
  }
  
  function set_session_box_option(value) {
    var s = document.getElementById("session_box");
    s.value = value;
  }
  
  function on_page_select_changed(layout) {
    current_layout = layout;
    for (var i = 0; i < NUM_BUTTONS; i++) { // update Buttons Selects
      update_button_selects("button_short", i);
      update_button_selects("button_long", i);
      update_button_selects("button_double", i);
    }
    for (var i = 0; i < NUM_LEDS; i++) { // update LEDs
     update_led_selects("led", i)
    }

    for (var i = 0; i < NUM_SLIDERS; i++) { // updates sliders
      update_slider_selects("slider", i)
    }

    for (var i = 0; i < NUM_ENCODERS; i++) { // updates encoders
      update_encoder_selects("encoder", i);
      update_encoder_selects("encoder_hold", i);
      update_button_selects("encoder_short", i);
    }

    update_display_select()
  }

  function update_button_selects(id, i) {
      _type = type[id][current_layout][i];
      _channel = channel[id][current_layout][i];
      _control = control[id][current_layout][i];
      _toggle = toggle[id][current_layout][i];

    // if (id == 'button_short') {
    //   var s = document.getElementById("checkbox" + i);
    //   s.checked = snap["button_short"][current_layout][i];
    //   update_snap_box(i, snap["button_short"][current_layout][i]);
    // }
    var s = document.getElementById(id + i);
    s.value = get_index(_control, actions[id]);
    update_custom_MIDI(id, i)
    // if (_type == 0 && _channel == 16) s.value = Object.keys(button_actions).indexOf("① MIDI Map 1 (Big Button)");
    // if (_type == 0 && _channel == 15) s.value = Object.keys(button_actions).indexOf("② MIDI Map 2 (Clear)");
    // if (_type == 0 && _channel == 14) s.value = Object.keys(button_actions).indexOf("③ MIDI Map 3");
    // if (_type == 0 && _channel == 13) s.value = Object.keys(button_actions).indexOf("④ MIDI Map 4");
    // if (_type == 0 && _channel == 12) s.value = Object.keys(button_actions).indexOf("⑤ MIDI Map 5");
    // if (_type == 0 && _channel == 11) s.value = Object.keys(button_actions).indexOf("⑥ MIDI Map 6");


  }

  function update_led_selects(id, i){
      var s = document.getElementById("led" + i);
      var c = document.getElementById("color_sel" + (i));
      c.style.display = "none";
      control_type = type["led"][current_layout][i];
      control_channel = channel["led"][current_layout][i];
      control_number = control["led"][current_layout][i];

      if (control_channel == 10) {
        s.value = 1;
        s.value = 0;
        c.style.display = "block";
        c.value = control_number;
      }
      else s.value = get_index(control["led"][current_layout][i], led_actions);
      s.style.display = "block";

  }

  function update_slider_selects(id, i){
      // var s = document.getElementById(id + i);
      // s.value = get_index(control[id][current_layout][i], action[id]);
      // update_custom_MIDI(id, i)
  }

  function update_encoder_selects(id, i){


      // var options_list = Object.keys(encoder_actions)
      var s = document.getElementById(id + i);
      // if (channel["encoder"][current_layout][i] < 11){
      //   s.value = Object.keys(encoder_actions).indexOf("Custom MIDI");
      //   set_encoder_custom_MIDI(i, "encoder", options_list[s.value])
      // var s3 = document.getElementById("custom_MIDI_encoder_cc_select" + i);
      // s3.value = control["encoder"][current_layout][i];
      // var s4 = document.getElementById("custom_MIDI_encoder_ch_select" + i);
      // s4.value = channel["encoder"][current_layout][i];
      // }
      // else 

      // console.log(id, id + i, control[id][current_layout][i], get_index(control[id][current_layout][i], actions[id]))
      s.value = get_index(control[id][current_layout][i], actions[id]);

      // var s = document.getElementById("encoder_hold" + i);
      // if (channel["encoder_hold"][current_layout][i] < 11){
      //   s.value = Object.keys(encoder_actions).indexOf("Custom MIDI");
      //   set_encoder_custom_MIDI(i, "encoder_hold", options_list[s.value])
      // var s3 = document.getElementById("custom_MIDI_encoder_hold_cc_select" + i);
      // s3.value = control["encoder_hold"][current_layout][i];
      // var s4 = document.getElementById("custom_MIDI_encoder_hold_ch_select" + i);
      // s4.value = channel["encoder_hold"][current_layout][i];
      // }
      // else 
      // s.value = get_index(control["encoder_hold"][current_layout][i], encoder_actions);

      // update_button_selects(current_layout, "encoder_short", i);
  }
  
  function update_display_select(){
    var s = document.getElementById("display0");
    s.value = get_index(control["display"][current_layout], display_actions);
  }

  function update_snap_box(num, value) {
    var s1 = document.getElementById("button_long" + num);
    var s2 = document.getElementById("button_double" + num);
    var l1 = document.getElementById("button_long_label" + num);
    var l2 = document.getElementById("button_double_label" + num);
    if (value == 1) {
      s1.style.visibility = "hidden";
      s2.style.visibility = "hidden";
      l1.style.visibility = "hidden";
      l2.style.visibility = "hidden";
    }
    else {
      s1.style.visibility = "visible";
      s2.style.visibility = "visible";
      l1.style.visibility = "visible";
      l2.style.visibility = "visible";
    }
    snap["button_short"][current_layout][num] = value;
  }

  function update_custom_MIDI(id, i) {
    _type = type[id][current_layout][i];
    _channel = channel[id][current_layout][i];
    _control = control[id][current_layout][i];
    _toggle = toggle[id][current_layout][i];
      var s1 = document.getElementById("custom_MIDI_" + id + i);
      var s2 = document.getElementById("custom_MIDI_"+id+"_type_select" + i);
      var s3 = document.getElementById("custom_MIDI_"+id+"_cc_select" + i);
      var s4 = document.getElementById("custom_MIDI_"+id+"_ch_select" + i);
      var s5 = document.getElementById("custom_MIDI_toggle_" + id+ i);
      var s6 = document.getElementById("custom_MIDI_toggle_" + id+ "_checkbox"+ i);

    if (_channel < 11 && _channel != 0) {
      s.value = Object.keys(actions[id]).indexOf("Custom MIDI");
      s1.style.visibility = "visible";
      s2.value = _type + 1;
      s3.value = _control;
      s4.value = _channel;
      s5.style.visibility = "visible";
      s6.checked = _toggle;
    }
    else {
      s1.style.visibility = "hidden";
      s5.style.visibility = "hidden";
    }
  }
  
  function get_index(control_number, action_type) {
    var values_list = Object.values(action_type)
    return values_list.indexOf(control_number);
  }

  //////////////////////////////////////////////////////////////////////
  // SEND SYSEX TO CONTROLS
  //////////////////////////////////////////////////////////////////////
 
  
  function set_button(id, num, value) {
  //   var options_list = Object.keys(button_actions); // retrieves the list of button actions
  //   cc_to_send = button_actions[options_list[value]]; // gets the cc corresponding to the action selected
  //   var s = document.getElementById(id + num);
  //   var snap = 1;
  //   s.style.display = "block";

  //   sysex_byte
  //   if (id == "button_short") {
  //     sysex_byte = 10;
  //     type["button_short"][current_layout][num] = 1;
  //     control["button_short"][current_layout][num] = cc_to_send;
  //     channel["button_short"][current_layout][num] = 16;
  //     sysex_num = num;
  //   }
  //   else if (id == "button_long") {
  //     sysex_byte = 12;
  //     type["button_long"][current_layout][num] = 1;
  //     control["button_long"][current_layout][num] = cc_to_send;
  //     channel["button_long"][current_layout][num] = 16;
  //     sysex_num = num;
  //   }
  //   else if (id == "button_double") {
  //     sysex_byte = 19;
  //     type["button_double"][current_layout][num] = 1;
  //     control["button_double"][current_layout][num] = cc_to_send;
  //     channel["button_double"][current_layout][num] = 16;
  //     sysex_num = num;
  //   }
  //   else if (id == "encoder_short") {
  //     sysex_byte = 10;
  //     type["encoder_short"][current_layout][num] = 1;
  //     control["encoder_short"][current_layout][num] = cc_to_send;
  //     channel["encoder_short"][current_layout][num] = 16;
  //     sysex_num = num + NUM_BUTTONS;
  //   }

  //   if (options_list[value] == "① MIDI Map 1 (Big Button)") {
  //     sendSysex(sysex_byte, current_layout, sysex_num, 1, 0, 16);
  //     // var s = document.getElementById(id + num);
  //     // s.style.display = "none";
  //   }
  //   else if (options_list[value] == "② MIDI Map 2 (Clear)") {
  //     sendSysex(sysex_byte, current_layout, sysex_num, 1, 0, 15);
  //   }
  //   else if (options_list[value] == "③ MIDI Map 3") {
  //     sendSysex(sysex_byte, current_layout, sysex_num, 1, 0, 14);
  //   }
  //   else if (options_list[value] == "④ MIDI Map 4") {
  //     sendSysex(sysex_byte, current_layout, sysex_num, 1, 0, 13);
  //   }
  //   else if (options_list[value] == "⑤ MIDI Map 5") {
  //     sendSysex(sysex_byte, current_layout, sysex_num, 1, 0, 12);
  //   }
  //   else if (options_list[value] == "⑥ MIDI Map 6") {
  //     sendSysex(sysex_byte, current_layout, sysex_num, 1, 0, 11);
  //   }
  //   else sendSysex(sysex_byte, current_layout, sysex_num, cc_to_send, 1, 16);
    
  //   if (options_list[value] == "Custom MIDI") {
  //     var s = document.getElementById("custom_MIDI_" + id + num);
  //     s.style.visibility = "visible";
  //     var s = document.getElementById("custom_MIDI_toggle_" + id + num);
  //     s.style.visibility = "visible";
  //   }
  //   else {
  //     on_toggle_changed(num, 0, "custom_MIDI_toggle_"+id)
  //     var s = document.getElementById("custom_MIDI_" + id + num);
  //     s.style.visibility = "hidden";
  //     var s = document.getElementById("custom_MIDI_toggle_" + id + num);
  //     s.style.visibility = "hidden";

  //   }
  //   if (id == "button_short") {
  //     var led_options_list = Object.keys(led_actions);
  //     index = led_options_list.indexOf(led_translator[options_list[value]]);
  //     led = document.getElementById("led" + (num));
  //     var led_cc = led_actions[led_translator[options_list[value]]];
  //     if (!isNaN(led_cc)) {
  //       led.value = index;
  //       // sendSysex(72, current_layout, id, led_cc, 1, 16);
  //       sendSysex(14, current_layout, num, led_cc, 1, 16);
  //     }
  //   }
  }

  function set_led(num, value) {
    // var options_list = Object.keys(led_actions)
    // cc_to_send = led_actions[options_list[value]];
    // var c = document.getElementById("color_sel" + (num));
    // if (cc_to_send == 0) {
    //   c.style.display = "block";
    //   channel["led"][current_layout][num] = 10;
    // }
    // else {
    //   c.style.display = "none";
    //   control["led"][current_layout][num] = cc_to_send;
    //   channel["led"][current_layout][num] = 16;
    //   sendSysex(14, current_layout, num, cc_to_send, 1, 16);
    // }

  }

  function set_encoder(id, num, value) {
  //   var options_list = Object.keys(encoder_actions)
  //   cc_to_send = encoder_actions[options_list[value]];
  //   set_encoder_custom_MIDI(num, id, options_list[value]);
  //   if (id == "encoder_hold") {
  //   control["encoder_hold"][current_layout][num] = cc_to_send;
  //   num = num+2;
  //   }
  //   else control["encoder"][current_layout][num] = cc_to_send;
  //   sendSysex(16, current_layout, num, cc_to_send, 1, 16);
  // }

  // function set_encoder_custom_MIDI(num, id, option) {
  //   if (option == "Custom MIDI") {
  //     var s = document.getElementById("custom_MIDI_" + id + num);
  //     s.style.visibility = "visible";

  //   }
  //   else {
  //     var s = document.getElementById("custom_MIDI_"+ id + num);
  //     s.style.visibility = "hidden";
  //   }
  }

  function set_slider(num, value) {
    // var options_list = Object.keys(slider_actions)
    // cc_to_send = slider_actions[options_list[value]];
    // control["slider"][current_layout][num] = cc_to_send;
    // sendSysex(17, current_layout, num, cc_to_send, 1, 16);

    // if (options_list[value] == "Custom MIDI") {
    //   var s = document.getElementById("custom_MIDI_slider" + num);
    //   s.style.visibility = "visible";
    // }
    // else {
    //   var s = document.getElementById("custom_MIDI_slider" + num);
    //   s.style.visibility = "hidden";
    // }
  }

  function set_display(num, value) {
    // var options_list = Object.keys(display_actions)
    // cc_to_send = display_actions[options_list[value]];
    // display[current_layout] = cc_to_send;
    // sendSysex(18, current_layout, 1, cc_to_send, 1, 16);
  }

  function set_External_MIDI(num, btn_ctrl, btn_chnl, btn_type) {
    var cc_sel = document.getElementById("external_MIDI_cc_select" + num);
    var ch_sel = document.getElementById("external_MIDI_ch_select" + num);
    // console.log("EXT", num, btn_type, btn_ctrl, btn_chnl)
    cc_sel.value = btn_ctrl;
    ch_sel.value = btn_chnl;
    if (num<8){
      var type_sel = document.getElementById("external_MIDI_type_select" + num);
      type_sel.value = btn_type;
    }
    external_MIDI[num] = [btn_type, btn_ctrl, btn_chnl];
  }

  // function send_cc(id, type, cc, ch) {
  //   button = document.getElementById("sel" + (id));
  //   var options_list = Object.keys(button_actions)
  //   if (options_list[button.value] == "Custom MIDI") {
  //     sendSysex(65, current_layout, id, cc, type, ch_values[ch])
  //   }
  // }


 ///////////////////////////////////
  // PRESETS HANDLING
  ///////////////////////////////////
 

  function create_preset_cell(div){
    var divClass = document.getElementsByClassName(div);
    var preset_buttons = [document.createElement('label'), document.createElement('label')];
    var save_button =  document.createElement('input');
    save_button.id = "save"
    save_button.type = "button"
    save_button.value = "Save"
    save_button.className = "preset"
    save_button.onclick = function() {
      var obj2 = {
        // type["button_short"] : type["button_short"][current_layout],
        // control["button_short"]: control["button_short"][current_layout],
        // channel["button_short"]: channel["button_short"][current_layout], 
        // toggle["button_short"]: toggle["button_short"][current_layout], 
        // snap["button_short"]: snap["button_short"][current_layout], 
        // type["button_long"]: type["button_long"][current_layout], 
        // control["button_long"]: control["button_long"][current_layout], 
        // channel["button_long"]: channel["button_long"][current_layout], 
        // toggle["button_long"]: toggle["button_long"][current_layout], 
        // type["button_double"]: type["button_double"][current_layout], 
        // control["button_double"]: control["button_double"][current_layout], 
        // channel["button_double"]: channel["button_double"][current_layout], 
        // toggle["button_double"]: toggle["button_double"][current_layout], 
        // type["led"]: type["led"][current_layout], 
        // control["led"]: control["led"][current_layout], 
        // channel["led"]: channel["led"][current_layout], 
        // type["encoder_short"]: type["encoder_short"][current_layout], 
        // control["encoder_short"]: control["encoder_short"][current_layout], 
        // channel["encoder_short"]: channel["encoder_short"][current_layout], 
        // control["encoder"]: control["encoder"][current_layout], 
        // channel["encoder"]: channel["encoder"][current_layout], 
        // control["encoder_hold"]: control["encoder_hold"][current_layout], 
        // channel["encoder_hold"]: channel["encoder_hold"][current_layout], 
        // control["slider"]: control["slider"][current_layout], 
        // channel["slider"]: channel["slider"][current_layout], 
        // display: display[current_layout]
      }
      saveText( JSON.stringify(obj2), "Page "+(current_layout+1)+".json" );
    }
    save_label = document.createElement('label');
    save_label.className = "preset"
    save_label.appendChild(document.createTextNode('Export'));
    save_label.htmlFor = "save"
    
    var load_button =  document.createElement('input');
    load_button.type = "file"
    load_button.id = "file-input"
    load_button.accept = ".json"
    load_button.className = "preset"
    load_button.addEventListener('change', readSingleFile, false);
    load_label = document.createElement('label');
    load_label.className = "preset"
    load_label.appendChild(document.createTextNode('Import'));
    load_label.htmlFor = "file-input"

    var upload_button =  document.createElement('input');
    upload_button.type = "button"
    upload_button.value = "Upload"
    upload_button.id = "upload"
    upload_button.className = "preset"
    upload_button.onclick = function() {uploadPreset()}
    upload_label = document.createElement('label');
    upload_label.className = "preset"
    upload_label.htmlFor = "upload"
    upload_label.appendChild(document.createTextNode('Upload'));
    preset_buttons[0].appendChild(save_label);
    preset_buttons[0].appendChild(save_button);
    preset_buttons[0].appendChild(load_label);
    preset_buttons[0].appendChild(load_button);
    preset_buttons[0].appendChild(upload_label);
    preset_buttons[0].appendChild(upload_button);
    return (preset_buttons[0])
  }

  function readSingleFile(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    displayContents(contents);
  };
  reader.readAsText(file);
}

function displayContents(contents) {
  elements = JSON.parse(contents);
  // type["button_short"][current_layout] = elements["type["button_short"]"];
  // control["button_short"][current_layout] = elements["control["button_short"]"];
  // channel["button_short"][current_layout] = elements["channel["button_short"]"];
  // toggle["button_short"][current_layout] = elements["toggle["button_short"]"];
  // snap["button_short"][current_layout] = elements["snap["button_short"]"];
  // type["button_long"][current_layout] = elements["type["button_long"]"];
  // control["button_long"][current_layout] = elements["control["button_long"]"];
  // channel["button_long"][current_layout] = elements["channel["button_long"]"];
  // toggle["button_long"][current_layout] = elements["toggle["button_long"]"];
  // type["button_double"][current_layout] = elements["type["button_double"]"];
  // control["button_double"][current_layout] = elements["control["button_double"]"];
  // channel["button_double"][current_layout] = elements["channel["button_double"]"];
  // toggle["button_double"][current_layout] = elements["toggle["button_double"]"];
  // type["led"][current_layout] = elements["type["led"]"];
  // control["led"][current_layout] = elements["control["led"]"];
  // channel["led"][current_layout] = elements["channel["led"]"];
  // type["encoder_short"][current_layout] = elements["type["encoder_short"]"];
  // control["encoder_short"][current_layout] = elements["control["encoder_short"]"];
  // channel["encoder_short"][current_layout] = elements["channel["encoder_short"]"];
  // control["encoder"][current_layout] = elements["control["encoder"]"];
  // channel["encoder"][current_layout] = elements["channel["encoder"]"];
  // control["encoder_hold"][current_layout] = elements["control["encoder_hold"]"];
  // channel["encoder_hold"][current_layout] = elements["channel["encoder_hold"]"];
  // control["slider"][current_layout] = elements["control["slider"]"];
  // channel["slider"][current_layout] = elements["channel["slider"]"];
  // display[current_layout] = elements["display"];

  on_page_select_changed(current_layout);
}


  function saveText(text, filename){
  var a = document.createElement('a');
  a.setAttribute('href', 'data:text/plain;charset=utf-8,'+encodeURIComponent(text));
  a.setAttribute('download', filename);
  a.click()
}


var pause = 2;

  function uploadPreset() { 
    console.log("bing")
    for (var i = 0; i < 6; i++) {
    show_receive_message();
   // "button_short"
   sendSysex(10, current_layout, i, control["button_short"][current_layout][i], type["button_short"][current_layout][i], channel["button_short"][current_layout][i]);
sleep(pause)
   // "button_long") 
   sendSysex(12, current_layout, i, control["button_long"][current_layout][i], type["button_long"][current_layout][i], channel["button_long"][current_layout][i]);
   sleep(pause)
 // "button_double"
   sendSysex(12, current_layout, i, control["button_double"][current_layout][i], type["button_double"][current_layout][i], channel["button_double"][current_layout][i]);
   sleep(pause)
 // "led"
    sendSysex(14, current_layout, i, control["led"][current_layout][i], 1, 16);
    sleep(pause)
 // snap
sendRawSysex([240, 122, 29, 1, 19, 11, current_layout, i, snap["button_short"][current_layout][i], 247]);
sleep(pause)
 // toggle short
        sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, toggle["button_short"][current_layout][i], 0, 247]);
        sleep(pause)
 // toggle long
        sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, toggle["button_long"][current_layout][i], 1, 247]);
sleep(pause)
// toggle double 
        sendRawSysex([240, 122, 29, 1, 19, 13, current_layout, i, toggle["button_double"][current_layout][i], 2, 247]);
}

show_receive_message();
    for (var i = 0; i < 2; i++) {
// "slider"
sleep(pause)
     sendSysex(17, current_layout, i, control["slider"][current_layout][i], 1, channel["slider"][current_layout][i]);
// encoder
sleep(pause)
     sendSysex(16, current_layout, i, control["encoder"][current_layout][i] , 1, channel["encoder"][current_layout][i]);
// "encoder_hold"
sleep(pause)
     sendSysex(16, current_layout, i+2, control["encoder_hold"][current_layout][i] , 1, channel["encoder_hold"][current_layout][i]);
// "encoder_short"
sleep(pause)
   sendSysex(10, current_layout, i+6, control["encoder_short"][current_layout][i], type["encoder_short"][current_layout][i], channel["encoder_short"][current_layout][i]);
    }

// display
sleep(pause)
   sendSysex(18, current_layout, 1, display[current_layout], 1, 16);
   request_Live_update()
  }

  function sleep(milliseconds) {
  const date = Date.now();
  let currentDate = null;
  do {
    currentDate = Date.now();
  } while (currentDate - date < milliseconds);
}

</script>

<!-- 
///////////////////////////////////
// HTML
/////////////////////////////////// -->

<html>

<head>

  <style>
    :root {
      --radius: 20px;
      --border: 1px;
      --border_color: #000000;
    }

    body {
      background-color: #777777;
      font-family: Helvetica;
      font-size: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border: 3px none rgb(128, 0, 128);
      color: rgb(231, 231, 231);
      font-family: "Helvetica Neue";
      border-collapse: separate;
      background-color: transparent;
      padding: 0px;
    }

    td {
      border: var(--border) none rgb(19, 170, 39);
      text-align: center;
      width: 50%;
    }

    .columns-container {
      display: table-cell;
      height: 100%;
      width: 20px;
      text-align: center;
    }

    #Options {
      /* width: 500px; */
      width: 1370px;
      /* padding-left: 920px; */
      /* padding-top: 10px; */
    }

    div.Layout {
      padding-top: 10px;
    }

    div.Sliders {
      align-items: center;
      width: 800px;
      padding-left: 254px;
    }

    div.Encoders {
      align-items: center;
      width: 800px;
      padding-left: 224px;
    }

    div.Display {
      /* align-items: center; */
      /* padding-top: 10px; */
      padding-left: 410px;
      width: 600px;
      text-align: center;
    }

    td.type_display {
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) solid var(--border_color);
      border-radius: var(--radius);
      height: 18px;
      padding-left: 50px;
      padding-bottom: 25px;
      padding-top: 25px;
    }

    select.display_select {
      color: rgb(0, 0, 0);
      font-family: Helvetica;
      background: rgb(255, 255, 255);
      height: 30px;
      width: 240px;
      padding-left: 5%;
      padding-right: 5%;
      /* padding-top: 55px; */
      /* font-weight: bold; */
      border-radius: 10px;
    }

    td.layout {
      text-align: center;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) solid rgb(0, 0, 0);
      border-radius: var(--radius);
      height: 18px;
      width: 200px;
      padding-left: 40px;
      padding-right: 5px;
    }


    td.type1 {
      text-align: center;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) solid rgb(0, 0, 0);
      border-radius: var(--radius);
      height: 18px;
      width: 100px;
      padding-left: 2px;
      padding-right: 2px;
      align-items: center;
    }

    td.main_cell {
      text-align: center;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) solid var(--border_color);
      border-radius: var(--radius);
      height: 18px;
      width: 100px;
      /* padding-left: 5px;
  padding-right: 5px; */
      align-items: center;
      padding-bottom: 10px;
    }

    td.color_sel {
      /* text-align: center; */
      border-collapse: separate;
      background: rgb(0, 0, 0);
      /* border-style: none; */
      border: var(--border) none rgb(252, 252, 252);
      height: 18px;
      width: 10px;
      padding-left: 5px;
      padding-right: 5px;
      /* align-items: center; */
    }

    table.type_layout {
      text-align: center;
      float: left;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      /* border-style: none; */
      border: var(--border) solid var(--border_color);
      border-radius: var(--radius);
      height: 18px;
      width: 220px;
      padding-left: 5px;
      padding-right: 5px;
    }

    table.type_options {
      /* text-align: center; */
      /* float: left; */
      border-collapse: separate;
      background: rgb(39, 39, 39);
      /* border-style: none; */
      border: var(--border) solid var(--border_color);
      border-radius: 4px;
      height: 18px;
      /* width: 800px; */
      padding-left: 5px;
      padding-right: 5px;
      align-items: left;
    }

    td.type_options {
      text-align: left;
      border-collapse: separate;
      background: rgb(39, 39, 39);
      border: var(--border) solid rgb(39, 39, 39);
      /* border-radius: var(--radius); */
      height: 18px;
      width: 25%;
      /* padding-left: 20px;
      padding-right: 20px; */
      align-items: left;
    }

    td.connect_cell {
      text-align: center;
      border-collapse: separate;
      background: rgb(255, 0, 0);
      border: var(--border) solid rgb(0, 0, 0);
      border-radius: var(--radius);
      height: 18px;
      width: 200px;
      padding-left: 40px;
      padding-right: 5px;
    }

    table.type_encoder {
      float: left;
      text-align: center;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      border: var(--border) none rgb(0, 0, 0);
      border-radius: var(--radius);
      height: 18px;
      width: 250px;
      padding-left: 2px;
      padding-right: 2px;
      align-items: center;
      border-collapse: separate;
      background-color: transparent;
    }

    table.type_slider {
      text-align: center;
      float: right;
      border-collapse: separate;
      background: rgb(0, 0, 0);
      /* border-style: none; */
      border: var(--border) solnoneid var(--border_color);
      border-radius: var(--radius);
      height: 18px;
      width: 250px;
      padding-left: 2px;
      padding-right: 2px;
      align-items: center;
      border-collapse: separate;
      background-color: transparent;
    }

    td.main_cell_text {
      text-align: center;
      width: 200px;
      background: rgb(0, 0, 0);
      border: var(--border) none rgb(172, 4, 4);
      column-span: 2;
      width: 120px;
      border-radius: 20px;
      padding-top: 15px;
      height: 60px;
      font-weight: bold;
      font-size: x-large;
      font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }

    table.external_midi_table td {
      border-collapse: separate;
      background: rgb(60, 60, 60);
      border-radius: 0px;
      text-align: center;
      width: 500px;
      padding-top: 5px;
    }

    select.select1 {
      color: rgb(0, 0, 0);
      font-family: Helvetica;
      background: rgb(255, 255, 255);
      height: 30px;
      width: 150px;
      /* font-weight: bold; */
      border-radius: 10px;
    }

    select.color_select {
      color: rgb(0, 0, 0);
      font-family: Helvetica;
      background: rgb(255, 255, 255);
      height: 30px;
      width: 40px;
      padding-left: 5%;
      padding-right: 5%;
      /* font-weight: bold; */
      border-radius: 10px;
    }

    div.ExternalMIDI {
      color: rgb(231, 231, 231);
      font-weight: bold;
      text-align: center;
      padding-top: 360px;
    }

    .slider {
      height: 80px;
      width: 380px;
      background: #fff;
      border-radius: 10px;
      padding: 0 65px 0 45px;
    }

    input[type="button"].preset {
  display: none;
}

input[type="file"].preset {
  display: none;
}


label.preset {
  content:'';
  border: 1px solid #f5f5f5;
  font-size: 10px;
  padding: 2 8px;
  /* padding-top: 6 6px; */
  padding-bottom: 0 16px;
  margin-right: 0.3rem;
  margin-top: 5px;
}

    input[type="checkbox"].demo2 {
  display: none;
}
input[type="checkbox"].demo2 + label::before {
  content:'';
  border: 1px solid #f5f5f5;
  font-size: 10px;
  padding: 2 8px;
  /* padding-top: 6 6px; */
  padding-bottom: 0 16px;
  margin-right: 0.3rem;
}
input[type="checkbox"].demo2:checked + label::before {
  background-color: #00B7E8;
}
input[type="checkbox"].snap {
  display: none;
}
input[type="checkbox"].snap + label::before {
  content:'Snap';
  border: 1px solid #f5f5f5;
  font-size: 10px;
  padding: 2 4px;
  margin-right: 0.3rem;
}
input[type="checkbox"].snap:checked + label::before {
  background-color: #00B7E8;
}
input[type="checkbox"].toggle {
  display: none;
}
input[type="checkbox"].toggle + label::before {
  content:'Toggle';
  border: 1px solid #f5f5f5;
  font-size: 10px;
  padding: 2 4px;
  margin-right: 0.3rem;
}
input[type="checkbox"].toggle:checked + label::before {
  background-color: #00B7E8;
}

  </style>
</head>
<title>open·control editor</title>

<body>

<div id="Options">
  <script>create_options_table("Options")</script>
</div>

  <div id="Layout">
    <script>create_layout_table("Layout")</script>
  </div>



  <div class="Display">
    <script>create_display_table("Display")</script>
  </div>
  <br>

  <div class="buttons_table">
    <script>create_buttons_table("buttons_table", 0)</script>
  </div>
  <br>
  <div class="Encoders">
    <script>create_encoder_table("Encoders")</script>
  </div>
  <div class="Sliders">
    <script>create_slider_table("Sliders")</script>
  </div>
  <br>
  <div class="ExternalMIDI">
    <hr>
    External MIDI
    <br>
    <br>
    <script>create_external_MIDI_table("ExternalMIDI")</script>
  </div>
</body>

</html>